## Objective + Task Context
- Objective: stop orphaned OpenCode CLIs from surviving Zellij tab/pane closure and bloating RAM; keep Pulse agent presence accurate.
- Active task/subtask IDs: ad-hoc request (no Taskmaster ID linked in this session).
- Tag: `master` (assumed default; `AOC_TAG` not set).

## Done
- Traced lifecycle issue and confirmed true orphan `opencode` binaries with `PPID=1` and stale pane/session env markers.
- Implemented Pulse stale-agent pruning in `crates/aoc-mission-control/src/main.rs` (offline grace + stale TTL + cascading task/diff cache prune).
- Implemented activity telemetry path (`agent_status.message`) and activity-age rendering across:
  - `crates/aoc-agent-wrap-rs/src/main.rs`
  - `crates/aoc-mission-control/src/main.rs`
- Implemented stronger pane-close cleanup in `bin/aoc-agent-wrap`:
  - split cleanup matcher (`kill_pane_agents_by_env`)
  - added detached orphan watchdog that triggers after wrapper parent dies
  - session-aware filtering to avoid cross-session kills.

## In Progress
- Live validation in real tab-close scenarios after deploying updated `bin/aoc-agent-wrap` to active runtime path (`~/.local/bin`).
- Optional extension of watchdog behavior to non-OpenCode agents.

## Blockers / Risks
- Current running panes may still use old installed wrapper (`~/.local/bin/aoc-agent-wrap`) until reinstall/sync.
- Existing orphan processes from previous runs remain until explicit cleanup.
- Watchdog currently targets OpenCode-family patterns only; other agent CLIs may still rely on old behavior.
- Durable decision pending on whether watchdog logic should live in Rust wrapper instead of bash script.

## Files Touched
- `bin/aoc-agent-wrap`
- `crates/aoc-agent-wrap-rs/src/main.rs`
- `crates/aoc-mission-control/src/main.rs`

## Last Command Outcomes
- `cargo check --manifest-path "crates/Cargo.toml" -p aoc-mission-control` pass.
- `cargo check --manifest-path "crates/Cargo.toml" -p aoc-agent-wrap-rs` pass (existing warnings only).
- `bash -n "bin/aoc-agent-wrap"` pass.
- Process inspections (`ps` + `/proc/*/environ`) confirmed orphan `opencode` processes persisted with stale `ZELLIJ_PANE_ID`.

## Open Decisions / Assumptions
- Assumption: pane-close can bypass shell traps, so detached watchdog is necessary.
- Assumption: matching by pane ID + session ID is safe enough for targeted kill.
- Promote to aoc-mem: final decision on long-term cleanup architecture (bash watchdog vs Rust-native parent-death supervision) once validated.

## Next 3-5 Concrete Steps
- Deploy wrapper change to runtime location (reinstall or sync `bin/aoc-agent-wrap` into `~/.local/bin`).
- Run a controlled test: open OpenCode pane, note PID chain, close pane/tab, verify all related PIDs exit within ~12s.
- Run `AOC_CLEANUP_INTERACTIVE=0 AOC_CLEANUP_SESSIONS=current AOC_CLEANUP_PANE_STRICT=1 aoc-cleanup` once to remove legacy orphans.
- If stable, extend watchdog pattern to Codex/Claude/Gemini/Kimi paths.
- If instability/false positives appear, migrate watchdog logic into `aoc-agent-wrap-rs` with stricter parent/session tracking.
