#!/usr/bin/env bash
set -euo pipefail

state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"
default_file="${AOC_AGENT_DEFAULT_FILE:-$state_dir/agent_default}"

normalize_agent() {
  local normalized
  normalized="$(printf "%s" "$1" | tr '[:upper:]' '[:lower:]')"
  case "$normalized" in
    pi|pi-agent|pi_agent)
      printf "pi"
      ;;
    *)
      printf "%s" "$normalized"
      ;;
  esac
}

agent="${AOC_AGENT_ID:-}"
if [[ -z "$agent" && -f "$default_file" ]]; then
  agent="$(cat "$default_file" 2>/dev/null || true)"
fi
if [[ -z "$agent" ]]; then
  agent="pi"
fi
agent="$(normalize_agent "$agent")"

if [[ "$agent" != "pi" ]]; then
  echo "Unsupported agent '$agent'. Supported agents: pi. Falling back to 'pi'." >&2
  agent="pi"
fi

if command -v aoc-skill >/dev/null 2>&1; then
  aoc-skill sync --agent "$agent" --quiet || true
fi

export AOC_AGENT_RUN=1
exec aoc-pi "$@"
