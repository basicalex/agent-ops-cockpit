#!/usr/bin/env bash
set -euo pipefail

# Forward known subcommands to the Rust CLI
if [[ $# -gt 0 ]]; then
  case "$1" in
    task|mem|--help|-h)
      # Assuming aoc-cli is in path or same directory
      DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
      if [[ -x "$DIR/aoc-cli" ]]; then
        exec "$DIR/aoc-cli" "$@"
      elif command -v aoc-cli >/dev/null 2>&1; then
        exec aoc-cli "$@"
      fi
      ;;
  esac
fi

aoc_fullscreen() {
  if [[ "${AOC_FULLSCREEN:-1}" == "0" ]]; then
    return 0
  fi

  if [[ "${XDG_SESSION_TYPE:-}" != "x11" ]]; then
    return 0
  fi

  local window_id="${ALACRITTY_WINDOW_ID:-${WINDOWID:-}}"
  if [[ -z "$window_id" ]]; then
    return 0
  fi

  if command -v wmctrl >/dev/null 2>&1; then
    wmctrl -ir "$window_id" -b add,fullscreen >/dev/null 2>&1 || true
    return 0
  fi

  if command -v xdotool >/dev/null 2>&1; then
    xdotool windowactivate "$window_id" >/dev/null 2>&1 || true
    xdotool windowstate --add FULLSCREEN "$window_id" >/dev/null 2>&1 || true
  fi
}

if [[ -n "${ZELLIJ:-}" ]]; then
  exec aoc-new-tab "$@"
fi

if [[ -n "${ZELLIJ_SESSION_NAME:-}" ]]; then
  if zellij action list-clients >/dev/null 2>&1; then
    exec aoc-new-tab "$@"
  fi
fi

aoc_fullscreen
exec aoc-launch
