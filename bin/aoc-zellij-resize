#!/usr/bin/env bash
set -euo pipefail

direction="${1:-}"
steps="${2:-1}"
border="${3:-right}"
delay="${AOC_ZELLIJ_RESIZE_DELAY_SECS:-0}"

if [[ -z "$direction" ]]; then
	exit 0
fi

if ! [[ "$steps" =~ ^[0-9]+$ ]]; then
	steps=1
fi

if ! [[ "$delay" =~ ^[0-9]*\.?[0-9]+$ ]]; then
	delay=0
fi

socket="${ZELLIJ:-}"
session="${ZELLIJ_SESSION_NAME:-}"

# In some zellij versions ZELLIJ can be "0" (marker, not socket path).
# Treat non-socket values as unset and resolve by session.
if [[ -n "$socket" && ! -S "$socket" ]]; then
	socket=""
fi

if [[ -z "$socket" && -n "$session" ]]; then
	uid=$(id -u)
	runtime="${XDG_RUNTIME_DIR:-/run/user/$uid}"
	base_dirs=("$runtime/zellij" "/run/user/$uid/zellij")
	for base in "${base_dirs[@]}"; do
		[[ -d "$base" ]] || continue
		if [[ -S "$base/$session" ]]; then
			socket="$base/$session"
			break
		fi
		for d in "$base"/*; do
			[[ -d "$d" ]] || continue
			if [[ -S "$d/$session" ]]; then
				socket="$d/$session"
				break 2
			fi
		done
	done
fi

run_resize() {
	if [[ -n "$socket" ]]; then
		ZELLIJ="$socket" zellij action resize "$direction" "$border" >/dev/null 2>&1
	else
		zellij action resize "$direction" "$border" >/dev/null 2>&1
	fi
}

for ((i = 0; i < steps; i++)); do
	if ! run_resize; then
		break
	fi
	if [[ "$delay" != "0" ]]; then
		sleep "$delay"
	fi
done
