#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: aoc-taskmaster [command]

Wraps the 'task-master' CLI for easy access within AOC.
If 'task-master' is not in PATH, falls back to the Rust `aoc task` CLI when available.

Commands:
  list       Show tasks
  add        Add a task
  status     Set task status
  next       Show next task
  ...        Pass-through to underlying task-master CLI
EOF
}

TM_CMD="${TM_CMD:-task-master}"

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
native_release="$script_dir/../crates/target/release/aoc-taskmaster"
native_debug="$script_dir/../crates/target/debug/aoc-taskmaster"

if [[ "${AOC_TASKMASTER_NATIVE:-0}" == "1" || $# -eq 0 ]]; then
  if [[ -n "${AOC_TASKMASTER_BIN:-}" ]]; then
    exec "$AOC_TASKMASTER_BIN" "$@"
  fi
  if [[ -x "$native_release" ]]; then
    exec "$native_release" "$@"
  fi
  if [[ -x "$native_debug" ]]; then
    exec "$native_debug" "$@"
  fi
  if command -v cargo >/dev/null 2>&1; then
    manifest_path=""
    if [[ -n "${AOC_PROJECT_ROOT:-}" && -f "${AOC_PROJECT_ROOT}/crates/Cargo.toml" ]]; then
      manifest_path="${AOC_PROJECT_ROOT}/crates/Cargo.toml"
    elif [[ -f "$script_dir/../crates/Cargo.toml" ]]; then
      manifest_path="$script_dir/../crates/Cargo.toml"
    fi
    if [[ -n "$manifest_path" ]]; then
      exec cargo run --manifest-path "$manifest_path" -p aoc-taskmaster -- "$@"
    fi
  fi
fi

# Auto-seed configuration from global defaults if available
seed_config() {
  local global_conf="$HOME/.taskmaster/config.json"
  local local_conf=".taskmaster/config.json"
  
  if [[ -f "$global_conf" ]]; then
    if [[ ! -f "$local_conf" ]]; then
      # If local config is missing, create dir and copy global
      mkdir -p .taskmaster
      cp "$global_conf" "$local_conf"
    elif [[ "${1:-}" == "init" ]]; then
      # If running init, force copy/overwrite to ensure defaults
      mkdir -p .taskmaster
      cp "$global_conf" "$local_conf"
    fi
  fi
}

# Check if the real task-master CLI is available
if command -v "$TM_CMD" >/dev/null 2>&1; then
  # Try to seed config before running
  seed_config "${1:-}"
  
  if [[ $# -eq 0 ]]; then
    # Interactive mode (TUI) if supported, or just list
    "$TM_CMD" list
  else
    # Pass-through all args
    exec "$TM_CMD" "$@"
  fi
else
  # Fallback for when the rust plugin/CLI isn't installed
  if command -v aoc >/dev/null 2>&1; then
    if [[ $# -eq 0 ]]; then
      exec aoc task list
    fi
    exec aoc task "$@"
  elif command -v aoc-cli >/dev/null 2>&1; then
    if [[ $# -eq 0 ]]; then
      exec aoc-cli task list
    fi
    exec aoc-cli task "$@"
  fi
  echo "aoc-taskmaster: '$TM_CMD' not found and aoc-cli unavailable."
  echo "Install task-master or build the Rust CLI." >&2
  exit 1
fi
