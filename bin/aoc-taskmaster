#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: aoc-taskmaster [command]

Wraps the 'task-master' CLI for easy access within AOC.
If 'task-master' is not in PATH, falls back to a simple shell-based list/edit loop.

Commands:
  list       Show tasks
  add        Add a task
  status     Set task status
  next       Show next task
  ...        Pass-through to underlying task-master CLI
EOF
}

TM_CMD="${TM_CMD:-task-master}"

# Auto-seed configuration from global defaults if available
seed_config() {
  local global_conf="$HOME/.taskmaster/config.json"
  local local_conf=".taskmaster/config.json"
  
  if [[ -f "$global_conf" ]]; then
    if [[ ! -f "$local_conf" ]]; then
      # If local config is missing, create dir and copy global
      mkdir -p .taskmaster
      cp "$global_conf" "$local_conf"
    elif [[ "${1:-}" == "init" ]]; then
      # If running init, force copy/overwrite to ensure defaults
      mkdir -p .taskmaster
      cp "$global_conf" "$local_conf"
    fi
  fi
}

# Check if the real task-master CLI is available
if command -v "$TM_CMD" >/dev/null 2>&1; then
  # Try to seed config before running
  seed_config "${1:-}"
  
  if [[ $# -eq 0 ]]; then
    # Interactive mode (TUI) if supported, or just list
    "$TM_CMD" list
  else
    # Pass-through all args
    exec "$TM_CMD" "$@"
  fi
else
  # Fallback for when the rust plugin/CLI isn't installed
  echo "aoc-taskmaster: '$TM_CMD' not found."
  echo "Please install claude-task-master or build the plugin."
  exit 1
fi