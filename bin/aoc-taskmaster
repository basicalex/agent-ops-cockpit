#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: aoc-taskmaster [command]

Wraps the 'task-master' CLI for easy access within AOC.
If 'task-master' is not in PATH, falls back to the Rust `aoc-task` CLI when available.

Commands:
  list       Show tasks
  add        Add a task
  status     Set task status
  next       Show next task
  ...        Pass-through to underlying task-master CLI

Options:
  --tm-root <path>  Read/write tasks from a different project root
EOF
}

TM_CMD="${TM_CMD:-task-master}"

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
native_release="$script_dir/../crates/target/release/aoc-taskmaster"
native_debug="$script_dir/../crates/target/debug/aoc-taskmaster"

tm_root="${AOC_TASKMASTER_ROOT:-}"
args=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --tm-root|--tm-source|--taskmaster-root)
      if [[ $# -lt 2 ]]; then
        echo "aoc-taskmaster: missing value for $1" >&2
        exit 2
      fi
      tm_root="$2"
      shift 2
      ;;
    --tm-root=*|--tm-source=*|--taskmaster-root=*)
      tm_root="${1#*=}"
      shift
      ;;
    *)
      args+=("$1")
      shift
      ;;
  esac
done

if [[ -n "$tm_root" ]]; then
  if [[ ! -d "$tm_root" ]]; then
    echo "aoc-taskmaster: tm root '$tm_root' is not a directory" >&2
    exit 2
  fi
  export AOC_TASKMASTER_ROOT="$(cd "$tm_root" && pwd -P)"
  cd "$AOC_TASKMASTER_ROOT"
fi

if [[ "${AOC_TASKMASTER_NATIVE:-0}" == "1" || ${#args[@]} -eq 0 ]]; then
  if [[ -n "${AOC_TASKMASTER_BIN:-}" ]]; then
    exec "$AOC_TASKMASTER_BIN" "${args[@]}"
  fi
  if command -v aoc-taskmaster-native >/dev/null 2>&1; then
    exec aoc-taskmaster-native "${args[@]}"
  fi
  if [[ -x "$native_release" ]]; then
    exec "$native_release" "${args[@]}"
  fi
  if [[ -x "$native_debug" ]]; then
    exec "$native_debug" "${args[@]}"
  fi
  if command -v cargo >/dev/null 2>&1; then
    manifest_path=""
    if [[ -n "${AOC_PROJECT_ROOT:-}" && -f "${AOC_PROJECT_ROOT}/crates/Cargo.toml" ]]; then
      manifest_path="${AOC_PROJECT_ROOT}/crates/Cargo.toml"
    elif [[ -f "$script_dir/../crates/Cargo.toml" ]]; then
      manifest_path="$script_dir/../crates/Cargo.toml"
    fi
    if [[ -n "$manifest_path" ]]; then
      exec cargo run --manifest-path "$manifest_path" -p aoc-taskmaster -- "${args[@]}"
    fi
  fi
fi

# Auto-seed configuration from global defaults if available
seed_config() {
  local global_conf="$HOME/.taskmaster/config.json"
  local local_conf=".taskmaster/config.json"
  
  if [[ -f "$global_conf" ]]; then
    if [[ ! -f "$local_conf" ]]; then
      # If local config is missing, create dir and copy global
      mkdir -p .taskmaster
      cp "$global_conf" "$local_conf"
    elif [[ "${1:-}" == "init" ]]; then
      # If running init, force copy/overwrite to ensure defaults
      mkdir -p .taskmaster
      cp "$global_conf" "$local_conf"
    fi
  fi
}

# Check if the real task-master CLI is available
if command -v "$TM_CMD" >/dev/null 2>&1; then
  # Try to seed config before running
  seed_config "${args[0]:-}"
  
  if [[ ${#args[@]} -eq 0 ]]; then
    # Interactive mode (TUI) if supported, or just list
    "$TM_CMD" list
  else
    # Pass-through all args
    exec "$TM_CMD" "${args[@]}"
  fi
else
  # Fallback for when the rust plugin/CLI isn't installed
  if command -v aoc-task >/dev/null 2>&1; then
    if [[ ${#args[@]} -eq 0 ]]; then
      exec aoc-task list
    fi
    exec aoc-task "${args[@]}"
  elif command -v aoc-cli >/dev/null 2>&1; then
    if [[ ${#args[@]} -eq 0 ]]; then
      exec aoc-cli task list
    fi
    exec aoc-cli task "${args[@]}"
  fi
  echo "aoc-taskmaster: '$TM_CMD' not found and aoc-cli unavailable."
  echo "Install task-master or build the Rust CLI." >&2
  exit 1
fi
