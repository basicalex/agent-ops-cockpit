#!/usr/bin/env bash
set -euo pipefail

project_root=""
if command -v aoc-align >/dev/null 2>&1; then
  project_root="$(aoc-align --print-root 2>/dev/null || true)"
fi
if [[ -z "$project_root" ]]; then
  project_root="$PWD"
fi

aoc_dir="$project_root/.aoc"
stm_dir="$aoc_dir/stm"
archive_dir="$stm_dir/archive"
current_file="$stm_dir/current.md"

usage() {
  cat <<EOF
Usage: aoc-stm [command] [args...]

Short-term memory (STM) manager for AOC.

Default behavior:
  aoc-stm
    Print the latest archived STM entry to stdout.

Commands:
  read [archive]        Print archived STM (latest by default).
  read-current          Print current STM draft file.
  current               Alias of read-current.
  add "note"            Append a timestamped note to current STM draft.
  edit                  Open current STM draft in your editor.
  archive               Archive current STM draft and clear current file.
  load [archive]        Copy archived STM back into current STM draft.
  history [limit]       List archived STM snapshots (newest first).
  path [archive]        Print archive path (latest by default).
  path current          Print current STM draft path.
  clear                 Clear current STM draft file.
  help                  Show this message.

Legacy aliases (non-launching):
  last, latest, start, --last, --latest, --l
  use [archive]
EOF
}

setup() {
  mkdir -p "$archive_dir"
  if [[ ! -f "$current_file" ]]; then
    : > "$current_file"
  fi
}

has_current_content() {
  [[ -f "$current_file" ]] && grep -q '[^[:space:]]' "$current_file"
}

sanitize_name() {
  local raw="$1"
  raw="$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]')"
  raw="$(printf '%s' "$raw" | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g')"
  printf '%s' "${raw:-session}"
}

latest_archive() {
  setup
  ls -1t "$archive_dir"/*.md 2>/dev/null | head -n 1 || true
}

resolve_archive() {
  setup
  local spec="${1:-}"
  local selected=""

  if [[ -z "$spec" ]]; then
    selected="$(latest_archive)"
    if [[ -n "$selected" ]]; then
      printf '%s' "$selected"
      return 0
    fi
    return 1
  fi

  if [[ -f "$spec" ]]; then
    printf '%s' "$spec"
    return 0
  fi
  if [[ -f "$archive_dir/$spec" ]]; then
    printf '%s' "$archive_dir/$spec"
    return 0
  fi
  if [[ -f "$archive_dir/$spec.md" ]]; then
    printf '%s' "$archive_dir/$spec.md"
    return 0
  fi

  selected="$(ls -1t "$archive_dir"/*"$spec"*.md 2>/dev/null | head -n 1 || true)"
  if [[ -n "$selected" ]]; then
    printf '%s' "$selected"
    return 0
  fi

  return 1
}

read_archive() {
  local archive_file=""
  local spec="${1:-}"
  archive_file="$(resolve_archive "${1:-}" || true)"
  if [[ -z "$archive_file" ]]; then
    echo "No STM archive available in $archive_dir." >&2
    if [[ -n "$spec" ]]; then
      echo "Requested archive: $spec" >&2
      echo "Tip: run 'aoc-stm history' to list local archives, or pass an absolute archive path." >&2
    else
      echo "Create STM notes with 'aoc-stm add <note>' then run 'aoc-stm archive'." >&2
    fi
    return 1
  fi
  cat "$archive_file"
}

read_current() {
  setup
  cat "$current_file"
}

list_history() {
  setup
  local limit="${1:-20}"
  if ! [[ "$limit" =~ ^[0-9]+$ ]]; then
    echo "history limit must be numeric" >&2
    exit 1
  fi

  mapfile -t files < <(ls -1t "$archive_dir"/*.md 2>/dev/null || true)
  if ((${#files[@]} == 0)); then
    echo "No STM archives found in $archive_dir"
    return 0
  fi

  local count=0
  local file
  for file in "${files[@]}"; do
    count=$((count + 1))
    printf '%2d. %s\n' "$count" "$(basename "$file")"
    if ((count >= limit)); then
      break
    fi
  done
}

archive_current() {
  setup
  if ! has_current_content; then
    return 1
  fi

  local ts session_label project_label archive_file
  ts="$(date -u '+%Y%m%d-%H%M%SZ')"
  session_label="$(sanitize_name "${ZELLIJ_SESSION_NAME:-${AOC_SESSION_ID:-adhoc}}")"
  project_label="$(sanitize_name "$(basename "$project_root")")"
  archive_file="$archive_dir/${ts}-${session_label}-${project_label}.md"

  cp "$current_file" "$archive_file"
  : > "$current_file"
  printf '%s' "$archive_file"
}

add_note() {
  local note="$1"
  local timestamp
  timestamp="$(date '+%Y-%m-%d %H:%M')"
  setup
  printf -- "- [%s] %s\n" "$timestamp" "$note" >> "$current_file"
  echo "STM note added."
}

cmd="${1:-read}"

case "$cmd" in
  read)
    shift || true
    read_archive "${1:-}"
    ;;
  read-current|current)
    read_current
    ;;
  add)
    shift
    if [[ -z "${1:-}" ]]; then
      echo "Error: note content required." >&2
      exit 1
    fi
    add_note "$*"
    ;;
  edit)
    setup
    "${EDITOR:-micro}" "$current_file"
    ;;
  archive)
    if archived="$(archive_current)"; then
      echo "Archived STM to $archived"
    else
      echo "No STM content to archive."
    fi
    ;;
  clear)
    setup
    : > "$current_file"
    echo "Cleared STM current file."
    ;;
  history|--history|--h)
    shift || true
    list_history "${1:-20}"
    ;;
  load)
    shift || true
    archive_file="$(resolve_archive "${1:-}" || true)"
    if [[ -z "$archive_file" ]]; then
      echo "No archive selected/found." >&2
      exit 1
    fi
    setup
    cp "$archive_file" "$current_file"
    echo "Loaded $archive_file into $current_file"
    ;;
  path)
    shift || true
    if [[ "${1:-}" == "current" ]]; then
      echo "$current_file"
      exit 0
    fi
    archive_file="$(resolve_archive "${1:-}" || true)"
    if [[ -z "$archive_file" ]]; then
      echo "No archive selected/found." >&2
      exit 1
    fi
    echo "$archive_file"
    ;;
  ""|start|last|latest|--last|--latest|--l)
    echo "aoc-stm: '$cmd' is deprecated and no longer launches a new tab. Printing latest archive." >&2
    read_archive
    ;;
  use)
    echo "aoc-stm: 'use' is deprecated. Use 'aoc-stm read [archive]' or 'aoc-stm load [archive]'." >&2
    shift || true
    read_archive "${1:-}"
    ;;
  help|-h|--help)
    usage
    ;;
  *)
    echo "Unknown command: $cmd" >&2
    usage
    exit 1
    ;;
esac
