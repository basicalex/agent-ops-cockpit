#!/usr/bin/env bash
set -euo pipefail

project_root=""
if command -v aoc-align >/dev/null 2>&1; then
  project_root="$(aoc-align --print-root 2>/dev/null || true)"
fi
if [[ -z "$project_root" ]]; then
  project_root="$PWD"
fi

aoc_dir="$project_root/.aoc"
stm_dir="$aoc_dir/stm"
archive_dir="$stm_dir/archive"
current_file="$stm_dir/current.md"
next_handoff_file="$stm_dir/next.path"

usage() {
  cat <<EOF
Usage: aoc-stm [command] [args...]

Short-term memory (STM) handoff manager for AOC agent sessions.

Commands:
  --last, last, start   Archive current STM, then use latest archived STM as handoff (default).
  add "note"            Append a timestamped note to current STM.
  edit                  Open current STM in your editor.
  read                  Print current STM file.
  path                  Print current STM path.
  archive               Archive current STM and clear current file.
  clear                 Clear current STM file.
  history [limit]       List archived STM snapshots (newest first).
  use [archive]         Launch AOC/new tab using an archived snapshot.
  load [archive]        Copy archived snapshot back into current STM.
  help                  Show this message.

Aliases:
  --last, --l           Same as: last
  --history, --h        Same as: history
  -h, --help            Show help
EOF
}

setup() {
  mkdir -p "$archive_dir"
  if [[ ! -f "$current_file" ]]; then
    : > "$current_file"
  fi
}

has_current_content() {
  [[ -f "$current_file" ]] && grep -q '[^[:space:]]' "$current_file"
}

sanitize_name() {
  local raw="$1"
  raw="$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]')"
  raw="$(printf '%s' "$raw" | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g')"
  printf '%s' "${raw:-session}"
}

archive_current() {
  setup
  if ! has_current_content; then
    return 1
  fi

  local ts session_label project_label archive_file
  ts="$(date -u '+%Y%m%d-%H%M%SZ')"
  session_label="$(sanitize_name "${ZELLIJ_SESSION_NAME:-${AOC_SESSION_ID:-adhoc}}")"
  project_label="$(sanitize_name "$(basename "$project_root")")"
  archive_file="$archive_dir/${ts}-${session_label}-${project_label}.md"

  cp "$current_file" "$archive_file"
  : > "$current_file"
  printf '%s' "$archive_file"
}

queue_handoff() {
  local handoff_file="$1"
  setup
  printf '%s\n' "$handoff_file" > "$next_handoff_file"
}

launch_with_handoff() {
  local handoff_file="$1"
  if [[ -n "${ZELLIJ:-}" || -n "${ZELLIJ_SESSION_NAME:-}" ]]; then
    AOC_STM_INJECT_FILE="$handoff_file" AOC_STM_ACTIVE_FILE="$current_file" aoc-new-tab --aoc
  else
    AOC_STM_INJECT_FILE="$handoff_file" AOC_STM_ACTIVE_FILE="$current_file" aoc-launch
  fi
}

launch_without_handoff() {
  if [[ -n "${ZELLIJ:-}" || -n "${ZELLIJ_SESSION_NAME:-}" ]]; then
    aoc-new-tab --aoc
  else
    aoc-launch
  fi
}

latest_archive() {
  setup
  ls -1t "$archive_dir"/*.md 2>/dev/null | head -n 1 || true
}

archive_current_if_present() {
  local archived_now=""
  if archived_now="$(archive_current 2>/dev/null)"; then
    echo "Archived STM to $archived_now"
  fi
}

use_latest_archive() {
  archive_current_if_present

  local handoff_file=""
  handoff_file="$(latest_archive)"
  if [[ -z "$handoff_file" ]]; then
    echo "No STM archive available in $archive_dir. Create STM notes first: aoc-stm add \"...\"" >&2
    echo "Then archive/start handoff: aoc-stm archive (or just aoc-stm)." >&2
    return 1
  fi

  queue_handoff "$handoff_file"
  echo "Queued STM handoff: $handoff_file"
  launch_with_handoff "$handoff_file"
}

list_history() {
  setup
  local limit="${1:-20}"
  if ! [[ "$limit" =~ ^[0-9]+$ ]]; then
    echo "history limit must be numeric" >&2
    exit 1
  fi

  mapfile -t files < <(ls -1t "$archive_dir"/*.md 2>/dev/null || true)
  if ((${#files[@]} == 0)); then
    echo "No STM archives found in $archive_dir"
    return 0
  fi

  local count=0
  local file
  for file in "${files[@]}"; do
    count=$((count + 1))
    printf '%2d. %s\n' "$count" "$(basename "$file")"
    if ((count >= limit)); then
      break
    fi
  done
}

resolve_archive() {
  setup
  local spec="${1:-}"
  local selected=""

  if [[ -z "$spec" ]]; then
    selected="$(latest_archive)"
    if [[ -n "$selected" ]]; then
      printf '%s' "$selected"
      return 0
    fi
    if command -v fzf >/dev/null 2>&1; then
      selected="$(ls -1t "$archive_dir"/*.md 2>/dev/null | fzf --prompt='STM archive > ' || true)"
      if [[ -n "$selected" ]]; then
        printf '%s' "$selected"
        return 0
      fi
    fi
    return 1
  fi

  if [[ -f "$spec" ]]; then
    printf '%s' "$spec"
    return 0
  fi
  if [[ -f "$archive_dir/$spec" ]]; then
    printf '%s' "$archive_dir/$spec"
    return 0
  fi
  if [[ -f "$archive_dir/$spec.md" ]]; then
    printf '%s' "$archive_dir/$spec.md"
    return 0
  fi

  selected="$(ls -1t "$archive_dir"/*"$spec"*.md 2>/dev/null | head -n 1 || true)"
  if [[ -n "$selected" ]]; then
    printf '%s' "$selected"
    return 0
  fi

  return 1
}

add_note() {
  local note="$1"
  local timestamp
  timestamp="$(date '+%Y-%m-%d %H:%M')"
  setup
  printf -- "- [%s] %s\n" "$timestamp" "$note" >> "$current_file"
  echo "STM note added."
}

cmd="${1:---last}"

case "$cmd" in
  ""|start|last|--last|--l)
    use_latest_archive
    ;;
  add)
    shift
    if [[ -z "${1:-}" ]]; then
      echo "Error: note content required." >&2
      exit 1
    fi
    add_note "$*"
    ;;
  edit)
    setup
    "${EDITOR:-micro}" "$current_file"
    ;;
  read)
    setup
    cat "$current_file"
    ;;
  path)
    echo "$current_file"
    ;;
  archive)
    if archived="$(archive_current)"; then
      queue_handoff "$archived"
      echo "Archived STM to $archived"
      echo "Queued as next handoff in $next_handoff_file"
    else
      echo "No STM content to archive."
    fi
    ;;
  clear)
    setup
    : > "$current_file"
    echo "Cleared STM current file."
    ;;
  history|--history|--h)
    shift || true
    list_history "${1:-20}"
    ;;
  use)
    shift || true
    archive_current_if_present
    archive_file="$(resolve_archive "${1:-}" || true)"
    if [[ -z "$archive_file" ]]; then
      echo "No archive selected/found." >&2
      exit 1
    fi
    queue_handoff "$archive_file"
    echo "Queued STM handoff: $archive_file"
    launch_with_handoff "$archive_file"
    ;;
  load)
    shift || true
    archive_file="$(resolve_archive "${1:-}" || true)"
    if [[ -z "$archive_file" ]]; then
      echo "No archive selected/found." >&2
      exit 1
    fi
    setup
    cp "$archive_file" "$current_file"
    echo "Loaded $archive_file into $current_file"
    ;;
  help|-h|--help)
    usage
    ;;
  *)
    echo "Unknown command: $1" >&2
    usage
    exit 1
    ;;
esac
