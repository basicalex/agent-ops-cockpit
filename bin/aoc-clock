#!/usr/bin/env bash
set -euo pipefail

# Set title early, before any execs
printf "\033]0;Clock\007"

interval="${AOC_CLOCK_INTERVAL:-1}"
if ! [[ "$interval" =~ ^[0-9]+$ ]]; then
  interval=1
fi

spawn="${AOC_CLOCK_SPAWN:-1}"
pane_name="${AOC_CLOCK_PANE_NAME:-aoc-clock}"
in_pane="${AOC_CLOCK_IN_PANE:-0}"
pane_direction="${AOC_CLOCK_PANE_DIRECTION:-up}"

time_format="${AOC_CLOCK_TIME_FORMAT:-%H:%M}"
date_format="${AOC_CLOCK_DATE_FORMAT:-%A, %B %d}"
font="${AOC_CLOCK_FONT:-small}"
backend="${AOC_CLOCK_BACKEND:-auto}"
tty_flags="${AOC_CLOCK_TTY_FLAGS:-}"

state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"
backend_file="${AOC_CLOCK_BACKEND_FILE:-$state_dir/clock_backend}"
flags_file="${AOC_CLOCK_TTY_FLAGS_FILE:-$state_dir/clock_tty_flags}"

have() { command -v "$1" >/dev/null 2>&1; }
term_cols() { tput cols 2>/dev/null || echo 0; }

if [[ -n "${ZELLIJ_SESSION_NAME:-}" && "$spawn" != "0" && "$in_pane" != "1" ]]; then
  if have zellij; then
    zellij action new-pane --direction "$pane_direction" --name "$pane_name" -- \
      bash -lc "AOC_CLOCK_IN_PANE=1 exec aoc-clock"
    exit 0
  fi
fi

load_setting() {
  local file="$1"
  local default="$2"
  if [[ -f "$file" ]]; then
    cat "$file" 2>/dev/null || echo "$default"
  else
    echo "$default"
  fi
}

if [[ "$backend" == "auto" ]]; then
  backend="$(load_setting "$backend_file" "auto")"
fi
if [[ -z "$tty_flags" ]]; then
  tty_flags="$(load_setting "$flags_file" "")"
fi

if [[ "$backend" == "auto" || "$backend" == "tty" ]]; then
  if have tty-clock; then
    read -r -a tty_args <<<"$tty_flags"
    exec tty-clock "${tty_args[@]}"
  fi
fi

center_lines() {
  local cols="$1"
  while IFS= read -r line; do
    local len="${#line}"
    local pad=0
    if [[ "$cols" -gt "$len" ]]; then
      pad=$(( (cols - len) / 2 ))
    fi
    printf '%*s%s\n' "$pad" "" "$line"
  done
}

while true; do
  clear
  printf "\033]0;Clock\007"
  now_time="$(date +"$time_format")"
  now_date="$(date +"$date_format")"
  cols="$(term_cols)"

  if have figlet; then
    figlet -f "$font" "$now_time" | center_lines "$cols"
  else
    printf '%s\n' "$now_time"
  fi

  if [[ "$cols" -gt 0 ]]; then
    printf '%s\n' "$now_date" | center_lines "$cols"
  else
    printf '%s\n' "$now_date"
  fi
  sleep "$interval"
done
