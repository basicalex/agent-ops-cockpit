#!/usr/bin/env bash
set -euo pipefail

interval="${AOC_CLOCK_INTERVAL:-1}"
if ! [[ "$interval" =~ ^[0-9]+$ ]]; then
  interval=1
fi

spawn="${AOC_CLOCK_SPAWN:-1}"
pane_name="${AOC_CLOCK_PANE_NAME:-aoc-clock}"
in_pane="${AOC_CLOCK_IN_PANE:-0}"
pane_direction="${AOC_CLOCK_PANE_DIRECTION:-up}"

time_format="${AOC_CLOCK_TIME_FORMAT:-%H:%M}"
date_format="${AOC_CLOCK_DATE_FORMAT:-%A, %B %d}"
font="${AOC_CLOCK_FONT:-small}"
backend="${AOC_CLOCK_BACKEND:-auto}"
tty_flags="${AOC_CLOCK_TTY_FLAGS:-}"
clocktemp_cmd="${AOC_CLOCK_CLOCKTEMP_CMD:-}"
clocktemp_flags="${AOC_CLOCK_CLOCKTEMP_FLAGS:-}"
auto_geo="${AOC_CLOCK_AUTO_GEO:-1}"
geo_ttl="${AOC_CLOCK_GEO_TTL:-86400}"

state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"
backend_file="${AOC_CLOCK_BACKEND_FILE:-$state_dir/clock_backend}"
flags_file="${AOC_CLOCK_TTY_FLAGS_FILE:-$state_dir/clock_tty_flags}"
clocktemp_flags_file="${AOC_CLOCK_CLOCKTEMP_FLAGS_FILE:-$state_dir/clocktemp_flags}"
geo_file="${AOC_CLOCK_GEO_FILE:-$state_dir/clock_geo}"

have() { command -v "$1" >/dev/null 2>&1; }
term_cols() { tput cols 2>/dev/null || echo 0; }

if [[ -n "${ZELLIJ_SESSION_NAME:-}" && "$spawn" != "0" && "$in_pane" != "1" ]]; then
  if have zellij; then
    zellij action new-pane --direction "$pane_direction" --name "$pane_name" -- \
      bash -lc "AOC_CLOCK_IN_PANE=1 exec aoc-clock"
    exit 0
  fi
fi

load_setting() {
  local file="$1"
  local default="$2"
  if [[ -f "$file" ]]; then
    cat "$file" 2>/dev/null || echo "$default"
  else
    echo "$default"
  fi
}

if [[ "$backend" == "auto" ]]; then
  backend="$(load_setting "$backend_file" "auto")"
fi
if [[ -z "$tty_flags" ]]; then
  tty_flags="$(load_setting "$flags_file" "")"
fi
if [[ -z "$clocktemp_flags" ]]; then
  clocktemp_flags="$(load_setting "$clocktemp_flags_file" "")"
fi

find_clocktemp_cmd() {
  if [[ -n "$clocktemp_cmd" ]]; then
    if command -v "$clocktemp_cmd" >/dev/null 2>&1; then
      echo "$clocktemp_cmd"
      return
    fi
  fi
  for candidate in clocktemp ClockTemp clock-temp; do
    if command -v "$candidate" >/dev/null 2>&1; then
      echo "$candidate"
      return
    fi
  done
}

have_lat_lon() {
  [[ " $clocktemp_flags " == *" -lat "* && " $clocktemp_flags " == *" -lon "* ]]
}

load_geo_cache() {
  if [[ -f "$geo_file" ]]; then
    read -r lat lon ts <"$geo_file" || return 1
    if [[ -n "${lat:-}" && -n "${lon:-}" && -n "${ts:-}" ]]; then
      now="$(date +%s)"
      if (( now - ts <= geo_ttl )); then
        echo "$lat $lon"
        return 0
      fi
    fi
  fi
  return 1
}

fetch_geo() {
  if ! have curl || ! have python3; then
    return 1
  fi
  local coords url
  for url in \
    "https://ipapi.co/json/" \
    "https://ipinfo.io/json" \
    "https://ifconfig.co/json"
  do
    coords="$(curl -fsSL "$url" | python3 -c 'import json,sys
try:
    data=json.load(sys.stdin)
    lat=data.get("latitude") or data.get("lat")
    lon=data.get("longitude") or data.get("lon")
    if (lat is None or lon is None) and isinstance(data.get("loc"), str):
        parts=data["loc"].split(",")
        if len(parts) == 2:
            lat, lon = parts[0].strip(), parts[1].strip()
    if lat is None or lon is None:
        sys.exit(1)
    print(f"{lat} {lon}")
except Exception:
    sys.exit(1)
'
)" && break || coords=""
  done
  if [[ -z "$coords" ]]; then
    return 1
  fi
  read -r lat lon <<<"$coords"
  if [[ -n "${lat:-}" && -n "${lon:-}" ]]; then
    mkdir -p "$(dirname "$geo_file")"
    printf '%s %s %s\n' "$lat" "$lon" "$(date +%s)" > "$geo_file"
    echo "$lat $lon"
    return 0
  fi
  return 1
}

if [[ "$backend" == "auto" || "$backend" == "clocktemp" ]]; then
  clocktemp_bin="$(find_clocktemp_cmd)"
  if [[ -n "$clocktemp_bin" ]]; then
    if [[ "$auto_geo" != "0" ]] && ! have_lat_lon; then
      coords="$(load_geo_cache || fetch_geo || true)"
      if [[ -n "$coords" ]]; then
        read -r lat lon <<<"$coords"
        clocktemp_flags="$clocktemp_flags -lat $lat -lon $lon"
      fi
    fi
    if [[ " $clocktemp_flags " != *" -s "* ]]; then
      clocktemp_flags="$clocktemp_flags -s false"
    fi
    read -r -a ct_args <<<"$clocktemp_flags"
    exec "$clocktemp_bin" "${ct_args[@]}"
  fi
fi

if [[ "$backend" == "auto" || "$backend" == "tty" ]]; then
  if have tty-clock; then
    read -r -a tty_args <<<"$tty_flags"
    exec tty-clock "${tty_args[@]}"
  fi
fi

center_lines() {
  local cols="$1"
  while IFS= read -r line; do
    local len="${#line}"
    local pad=0
    if [[ "$cols" -gt "$len" ]]; then
      pad=$(( (cols - len) / 2 ))
    fi
    printf '%*s%s\n' "$pad" "" "$line"
  done
}

while true; do
  clear
  now_time="$(date +"$time_format")"
  now_date="$(date +"$date_format")"
  cols="$(term_cols)"

  if have figlet; then
    figlet -f "$font" "$now_time" | center_lines "$cols"
  else
    printf '%s\n' "$now_time"
  fi

  if [[ "$cols" -gt 0 ]]; then
    printf '%s\n' "$now_date" | center_lines "$cols"
  else
    printf '%s\n' "$now_date"
  fi
  sleep "$interval"
done
