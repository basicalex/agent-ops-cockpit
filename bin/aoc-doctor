#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: aoc-doctor [--quiet]

Checks for required and optional dependencies used by Agent Ops Cockpit.
Exit codes:
  0  All required tools are present.
  1  One or more required tools are missing.
EOF
}

quiet=0
case "${1:-}" in
  --quiet) quiet=1 ;;
  -h|--help) usage; exit 0 ;;
  "") ;;
  *) echo "Unknown option: $1" >&2; usage; exit 1 ;;
esac

have() { command -v "$1" >/dev/null 2>&1; }
have_bat() { have bat || have batcat; }

detect_pm() {
  if have apt-get; then echo "apt"; return; fi
  if have dnf; then echo "dnf"; return; fi
  if have pacman; then echo "pacman"; return; fi
  if have brew; then echo "brew"; return; fi
  if have apk; then echo "apk"; return; fi
  echo "unknown"
}

pm="$(detect_pm)"

hint_for() {
  local tool="$1"
  case "$tool" in
    zellij)
      case "$pm" in
        apt) echo "sudo apt-get install -y zellij" ;;
        dnf) echo "sudo dnf install -y zellij" ;;
        pacman) echo "sudo pacman -S zellij" ;;
        brew) echo "brew install zellij" ;;
        apk) echo "sudo apk add zellij" ;;
        *) echo "Install zellij via your package manager." ;;
      esac
      ;;
    yazi)
      echo "cargo install --locked yazi-fm yazi-cli"
      ;;
    fzf)
      case "$pm" in
        apt) echo "sudo apt-get install -y fzf" ;;
        dnf) echo "sudo dnf install -y fzf" ;;
        pacman) echo "sudo pacman -S fzf" ;;
        brew) echo "brew install fzf" ;;
        apk) echo "sudo apk add fzf" ;;
        *) echo "Install fzf via your package manager." ;;
      esac
      ;;
    tmux)
      case "$pm" in
        apt) echo "sudo apt-get install -y tmux" ;;
        dnf) echo "sudo dnf install -y tmux" ;;
        pacman) echo "sudo pacman -S tmux" ;;
        brew) echo "brew install tmux" ;;
        apk) echo "sudo apk add tmux" ;;
        *) echo "Install tmux via your package manager." ;;
      esac
      ;;
    codex)
      echo "Install the Codex CLI and ensure it is in PATH."
      ;;
    chafa)
      case "$pm" in
        apt) echo "sudo apt-get install -y chafa" ;;
        dnf) echo "sudo dnf install -y chafa" ;;
        pacman) echo "sudo pacman -S chafa" ;;
        brew) echo "brew install chafa" ;;
        apk) echo "sudo apk add chafa" ;;
        *) echo "Install chafa via your package manager." ;;
      esac
      ;;
    ffmpeg)
      case "$pm" in
        apt) echo "sudo apt-get install -y ffmpeg" ;;
        dnf) echo "sudo dnf install -y ffmpeg" ;;
        pacman) echo "sudo pacman -S ffmpeg" ;;
        brew) echo "brew install ffmpeg" ;;
        apk) echo "sudo apk add ffmpeg" ;;
        *) echo "Install ffmpeg via your package manager." ;;
      esac
      ;;
    rsvg-convert)
      case "$pm" in
        apt) echo "sudo apt-get install -y librsvg2-bin" ;;
        dnf) echo "sudo dnf install -y librsvg2-tools" ;;
        pacman) echo "sudo pacman -S librsvg" ;;
        brew) echo "brew install librsvg" ;;
        apk) echo "sudo apk add librsvg" ;;
        *) echo "Install librsvg (rsvg-convert) via your package manager." ;;
      esac
      ;;
    pdftoppm)
      case "$pm" in
        apt) echo "sudo apt-get install -y poppler-utils" ;;
        dnf) echo "sudo dnf install -y poppler-utils" ;;
        pacman) echo "sudo pacman -S poppler" ;;
        brew) echo "brew install poppler" ;;
        apk) echo "sudo apk add poppler-utils" ;;
        *) echo "Install poppler-utils (pdftoppm) via your package manager." ;;
      esac
      ;;
    rg)
      case "$pm" in
        apt) echo "sudo apt-get install -y ripgrep" ;;
        dnf) echo "sudo dnf install -y ripgrep" ;;
        pacman) echo "sudo pacman -S ripgrep" ;;
        brew) echo "brew install ripgrep" ;;
        apk) echo "sudo apk add ripgrep" ;;
        *) echo "Install ripgrep via your package manager." ;;
      esac
      ;;
    bat)
      case "$pm" in
        apt) echo "sudo apt-get install -y bat # binary is batcat on Ubuntu" ;;
        dnf) echo "sudo dnf install -y bat" ;;
        pacman) echo "sudo pacman -S bat" ;;
        brew) echo "brew install bat" ;;
        apk) echo "sudo apk add bat" ;;
        *) echo "Install bat via your package manager." ;;
      esac
      ;;
    tectonic)
      case "$pm" in
        apt) echo "sudo apt-get install -y tectonic" ;;
        dnf) echo "sudo dnf install -y tectonic" ;;
        pacman) echo "sudo pacman -S tectonic" ;;
        brew) echo "brew install tectonic" ;;
        apk) echo "sudo apk add tectonic" ;;
        *) echo "cargo binstall tectonic (or cargo +1.78.0 install --locked tectonic --version 0.14.1)" ;;
      esac
      ;;
    task-master)
      echo "Install task-master for npm-based task control (optional if using 'aoc task')."
      ;;
    python3)
      case "$pm" in
        apt) echo "sudo apt-get install -y python3" ;;
        dnf) echo "sudo dnf install -y python3" ;;
        pacman) echo "sudo pacman -S python" ;;
        brew) echo "brew install python" ;;
        apk) echo "sudo apk add python3" ;;
        *) echo "Install python3 via your package manager." ;;
      esac
      ;;
    git)
      case "$pm" in
        apt) echo "sudo apt-get install -y git" ;;
        dnf) echo "sudo dnf install -y git" ;;
        pacman) echo "sudo pacman -S git" ;;
        brew) echo "brew install git" ;;
        apk) echo "sudo apk add git" ;;
        *) echo "Install git via your package manager." ;;
      esac
      ;;
    *)
      echo "Install $tool via your package manager."
      ;;
  esac
}

required=(zellij yazi fzf codex)
optional=(tmux chafa ffmpeg rsvg-convert pdftoppm rg bat tectonic task-master python3 git)

missing_required=()
missing_optional=()

for tool in "${required[@]}"; do
  if ! have "$tool"; then
    missing_required+=("$tool")
  fi
done

for tool in "${optional[@]}"; do
  if [[ "$tool" == "bat" ]]; then
    if ! have_bat; then
      missing_optional+=("$tool")
    fi
  elif [[ "$tool" == "task-master" ]]; then
    if have aoc || have aoc-cli; then
      continue
    fi
    if ! have task-master && ! have task-master-ai; then
      missing_optional+=("$tool")
    fi
  elif ! have "$tool"; then
    missing_optional+=("$tool")
  fi
done

if [[ "$quiet" -eq 0 ]]; then
  echo "AOC Doctor"
  echo "=========="
  
  echo "Project Integrity:"
  if [[ -d ".aoc" ]]; then
    echo "  [ok] .aoc/ directory found"
    if [[ -f ".aoc/context.md" ]]; then
      echo "    [ok] context.md present"
    else
      echo "    [missing] context.md"
    fi
    if [[ -f ".aoc/memory.md" ]]; then
      echo "    [ok] memory.md present"
    else
      echo "    [missing] memory.md"
    fi
  elif [[ -d ".gemini" ]]; then
    echo "  [warn] .gemini/ found (legacy). Run 'aoc-init' to migrate to .aoc/"
  else
    echo "  [missing] .aoc/ directory. Run 'aoc-init' to initialize."
  fi
  echo

  echo "Required Tools:"
  for tool in "${required[@]}"; do
    if have "$tool"; then
      echo "  [ok] $tool"
    else
      echo "  [missing] $tool"
      echo "    -> $(hint_for "$tool")"
    fi
  done
  echo
  echo "Optional (features may degrade if missing):"
  for tool in "${optional[@]}"; do
    if [[ "$tool" == "bat" ]]; then
      if have bat; then
        echo "  [ok] bat"
      elif have batcat; then
        echo "  [ok] bat (via batcat)"
      else
        echo "  [missing] bat"
        echo "    -> $(hint_for "$tool")"
      fi
    elif have "$tool"; then
      echo "  [ok] $tool"
    else
      echo "  [missing] $tool"
      echo "    -> $(hint_for "$tool")"
    fi
  done
fi

if [[ "${#missing_required[@]}" -gt 0 ]]; then
  exit 1
fi
exit 0
