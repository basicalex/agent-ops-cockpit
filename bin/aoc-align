#!/usr/bin/env bash
set -euo pipefail

print_only=false
if [[ "${1:-}" == "--print-root" ]]; then
  print_only=true
  shift
fi

if [[ -z "${ZELLIJ:-}" && -z "${ZELLIJ_SESSION_NAME:-}" ]]; then
  exit 0
fi

# Derive project root directly from the Zellij layout
# 1. Get the base cwd from layout header (e.g., /home/user/dev)
# 2. Get the Agent pane's cwd from focused tab (e.g., agent-ops-cockpit)
# 3. Combine them to get the full project root
discover_project_root() {
  local layout_dump base_cwd pane_cwd in_focus_section
  layout_dump="$(zellij action dump-layout 2>/dev/null || true)"
  
  if [[ -z "$layout_dump" ]]; then
    return
  fi
  
  # Extract base cwd from layout header: cwd "/home/ceii/dev"
  base_cwd="$(echo "$layout_dump" | sed -n 's/^[[:space:]]*cwd "\([^"]*\)".*/\1/p' | head -1)"
  
  # Extract just the focused tab section (POSIX-compatible awk)
  in_focus_section="$(echo "$layout_dump" | awk '
    /^    tab .*focus=true/ { in_focus=1; next }
    /^    tab / { if(in_focus) exit; in_focus=0 }
    in_focus { print }
  ')"
  
  # Extract the Agent pane's cwd attribute
  pane_cwd="$(echo "$in_focus_section" | grep 'name="Agent \[' | head -1 | sed -n 's/.*cwd="\([^"]*\)".*/\1/p')"
  
  if [[ -z "$pane_cwd" ]]; then
    return
  fi
  
  # If pane_cwd is absolute, use it directly; otherwise combine with base_cwd
  if [[ "$pane_cwd" == /* ]]; then
    echo "$pane_cwd"
  elif [[ -n "$base_cwd" ]]; then
    echo "${base_cwd}/${pane_cwd}"
  else
    # Fallback: assume pane_cwd is relative to home dev directory
    echo "$HOME/dev/${pane_cwd}"
  fi
}

root="$(discover_project_root)"

if [[ "${AOC_ALIGN_DEBUG:-}" == "1" ]]; then
  echo "aoc-align root: ${root:-<empty>}" >&2
fi

if [[ "$print_only" == "true" ]]; then
  printf '%s' "$root"
  exit 0
fi

if [[ -z "$root" ]]; then
  exit 0
fi

payload="cd \"${root}\" && clear"$'\n'
zellij action write-chars "$payload" >/dev/null 2>&1 || true
