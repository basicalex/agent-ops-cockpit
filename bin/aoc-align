#!/usr/bin/env bash
set -euo pipefail

print_only=false
if [[ "${1:-}" == "--print-root" ]]; then
  print_only=true
  shift
fi

if [[ -z "${ZELLIJ:-}" && -z "${ZELLIJ_SESSION_NAME:-}" ]]; then
  exit 0
fi

state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"

# Discover root_tag from pane names in the current tab
# Layout panes named "aoc:<root_tag>" serve as markers
discover_root_from_pane_names() {
  # Skip if already set via environment
  if [[ -n "${AOC_PROJECT_ROOT_FILE:-}" && -f "${AOC_PROJECT_ROOT_FILE:-}" ]]; then
    return 0
  fi

  local layout_dump root_tag
  layout_dump="$(zellij action dump-layout 2>/dev/null || true)"
  
  # Extract root_tag from pane name="aoc:<root_tag>" pattern
  # The focused tab's panes are in the current dump
  root_tag="$(echo "$layout_dump" | grep -oP 'pane[^}]*name="aoc:\K[^"]+' | head -1 || true)"
  
  if [[ -n "$root_tag" && "$root_tag" != "__AOC_ROOT_TAG__" ]]; then
    AOC_PROJECT_ROOT_FILE="${AOC_PROJECT_ROOT_FILE:-$state_dir/project_root.${root_tag}}"
    AOC_STAR_FILE="${AOC_STAR_FILE:-$state_dir/starred_root.${root_tag}}"
  fi
}

discover_root_from_pane_names

root=""
if [[ -n "${AOC_STAR_FILE:-}" && -f "$AOC_STAR_FILE" ]]; then
  root="$(cat "$AOC_STAR_FILE" 2>/dev/null || true)"
elif [[ -n "${AOC_PROJECT_ROOT_FILE:-}" && -f "$AOC_PROJECT_ROOT_FILE" ]]; then
  root="$(cat "$AOC_PROJECT_ROOT_FILE" 2>/dev/null || true)"
fi

if [[ "${AOC_ALIGN_DEBUG:-}" == "1" ]]; then
  echo "aoc-align root: ${root:-<empty>}" >&2
fi

if [[ "$print_only" == "true" ]]; then
  printf '%s' "$root"
  exit 0
fi

if [[ -z "$root" ]]; then
  exit 0
fi

payload="cd \"${root}\" && clear"$'\n'
zellij action write-chars "$payload" >/dev/null 2>&1 || true
