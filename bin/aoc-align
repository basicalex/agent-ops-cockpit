#!/usr/bin/env bash
set -euo pipefail

# aoc-align: Discover project root for the current AOC tab
#
# Strategy:
# 1. If inside Zellij, use `zellij action dump-layout` to get layout
# 2. Find the focused tab (has focus=true attribute)
# 3. Within that tab, find the Agent pane by name pattern "Agent [<agent_id>]"
# 4. Derive root as ~/dev/<agent_id>
# 5. Fall back to walking up from $PWD looking for .aoc or .git

print_only=false
if [[ "${1:-}" == "--print-root" ]]; then
  print_only=true
  shift
fi

# Base directory where projects live
AOC_PROJECTS_BASE="${AOC_PROJECTS_BASE:-$HOME/dev}"

# Extract the focused tab's content from the layout dump
# Returns just the KDL content between the focused tab's braces
extract_focused_tab() {
  local layout="$1"
  
  # Use awk to find the tab with focus=true and extract its content
  echo "$layout" | awk '
    BEGIN { in_focused_tab = 0; brace_depth = 0; }
    
    # Match a tab line with focus=true
    /^[[:space:]]*tab[[:space:]].*focus=true/ {
      in_focused_tab = 1
      brace_depth = 0
    }
    
    in_focused_tab {
      # Count opening braces
      n = gsub(/{/, "{")
      brace_depth += n
      
      # Print line if we are inside the focused tab
      if (brace_depth > 0) {
        print
      }
      
      # Count closing braces
      n = gsub(/}/, "}")
      brace_depth -= n
      
      # If we have closed all braces, we are done with the focused tab
      if (brace_depth <= 0 && in_focused_tab == 1) {
        in_focused_tab = 0
        exit
      }
    }
  '
}

# Try to get root from Zellij layout by parsing Agent pane name in focused tab
discover_from_zellij() {
  # Try to get layout - works if we're in a Zellij-managed pane even without env vars
  local layout
  layout="$(zellij action dump-layout 2>/dev/null)" || return 1

  if [[ -z "$layout" ]]; then
    return 1
  fi

  # Extract just the focused tab's content
  local focused_tab
  focused_tab="$(extract_focused_tab "$layout")"
  
  if [[ -z "$focused_tab" ]]; then
    return 1
  fi

  # Look for Agent pane pattern within the focused tab: name="Agent [<agent_id>]"
  # The agent_id is the directory name (e.g., agent-ops-cockpit)
  local agent_id
  agent_id="$(echo "$focused_tab" | grep -oP 'name="Agent \[\K[^\]]+' | head -1)" || true

  if [[ -z "$agent_id" ]]; then
    return 1
  fi

  # Derive project root from agent_id
  local root="${AOC_PROJECTS_BASE}/${agent_id}"

  if [[ -d "$root" ]]; then
    echo "$root"
    return 0
  fi

  return 1
}

# Fall back to walking up from PWD
discover_from_pwd() {
  local probe="$PWD"

  while [[ -n "$probe" && "$probe" != "/" ]]; do
    if [[ -d "$probe/.aoc" ]]; then
      echo "$probe"
      return 0
    fi
    if [[ -d "$probe/.git" ]]; then
      echo "$probe"
      return 0
    fi
    probe="$(dirname "$probe")"
  done

  # Last resort: current directory
  echo "$PWD"
}

# Main discovery logic
root=""

# Try Zellij-based discovery first (works even without ZELLIJ env var)
if root="$(discover_from_zellij 2>/dev/null)" && [[ -n "$root" ]]; then
  : # Success
else
  # Fall back to PWD-based discovery
  root="$(discover_from_pwd)"
fi

if [[ "${AOC_ALIGN_DEBUG:-}" == "1" ]]; then
  echo "aoc-align root: ${root:-<empty>}" >&2
fi

if [[ "$print_only" == "true" ]]; then
  printf '%s' "$root"
  exit 0
fi

if [[ -z "$root" ]]; then
  exit 0
fi

# If not in Zellij context at all, don't try to write chars
if ! zellij action dump-layout >/dev/null 2>&1; then
  exit 0
fi

payload="cd \"${root}\" && clear"$'\n'
zellij action write-chars "$payload" >/dev/null 2>&1 || true
