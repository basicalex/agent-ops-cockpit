#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: aoc-new-tab [--aoc|--plugin|--default] [--layout NAME] [--name NAME] [--cwd PATH]

Create a new Zellij tab. Prompts for layout if not specified.
--plugin is a legacy alias of --aoc.
EOF
}

layout_choice=""
tab_name=""
tab_cwd=""
state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"
default_layout_file="${state_dir}/layout_default"

if [[ "${AOC_CLEANUP:-1}" != "0" ]]; then
  if command -v aoc-cleanup >/dev/null 2>&1; then
    cleanup_log="$state_dir/cleanup.log"
    mkdir -p "$state_dir"
    (aoc-cleanup >>"$cleanup_log" 2>&1) &
  fi
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --aoc) layout_choice="aoc" ;;
    --plugin) layout_choice="aoc" ;;
    --default) layout_choice="default" ;;
    --layout)
      shift
      layout_choice="${1:-}"
      ;;
    --name)
      shift
      tab_name="${1:-}"
      ;;
    --cwd)
      shift
      tab_cwd="${1:-}"
      ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown option: $1" >&2; usage; exit 1 ;;
  esac
  shift || true
done

sanitize_name() {
  local raw="$1"
  raw="$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]')"
  raw="$(printf '%s' "$raw" | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g')"
  printf '%s' "${raw:-tab}"
}

cleanup_state() {
  local dir="$1"
  # Clean up old temp layout files
  find "$dir" -maxdepth 1 -type f -name 'aoc-layout-*' -mtime +30 -delete 2>/dev/null || true
  # Clean up deprecated root files (legacy)
  find "$dir" -maxdepth 1 -type f -name 'project_root.*' -delete 2>/dev/null || true
}

resolve_layout_path() {
  local layout_name="$1"
  if [[ "$layout_name" == /* || "$layout_name" == *.kdl ]]; then
    printf '%s' "$layout_name"
    return
  fi
  printf '%s' "$HOME/.config/zellij/layouts/${layout_name}.kdl"
}


realign_current_pane() {
  local root="$1"
  local delay="${2:-0}"
  if [[ -z "${ZELLIJ_SESSION_NAME:-}" ]]; then
    return
  fi
  if [[ -z "$root" ]]; then
    return
  fi
  local cmd=""
  if [[ "$delay" != "0" ]]; then
    cmd="sleep ${delay}; "
  fi
  cmd+="cd \"${root}\" && clear"
  local payload
  payload="${cmd}"$'\n'
  zellij action write-chars "$payload" >/dev/null 2>&1 || true
}

# Determine layout choice logic:
# 1. CLI arg (--layout, --aoc, etc)
# 2. Env var (AOC_LAYOUT)
# 3. Persistent default file
# 4. Fallback to "aoc"
if [[ -z "$layout_choice" ]]; then
  if [[ -n "${AOC_LAYOUT:-}" ]]; then
    layout_choice="$AOC_LAYOUT"
  elif [[ -f "$default_layout_file" ]]; then
    layout_choice="$(cat "$default_layout_file")"
  else
    layout_choice="aoc"
  fi
fi

if [[ -z "$layout_choice" ]]; then
  layout_choice="aoc"
fi

args=()
if [[ -n "$tab_name" ]]; then
  args+=(--name "$tab_name")
fi
if [[ -n "$tab_cwd" ]]; then
  args+=(--cwd "$tab_cwd")
else
  args+=(--cwd "$PWD")
fi

current_pwd="$(pwd -P)"
project_root="${tab_cwd:-$current_pwd}"

current_root=""
if command -v aoc-align >/dev/null 2>&1; then
  current_root="$(aoc-align --print-root || true)"
fi


mkdir -p "$state_dir"
cleanup_state "$state_dir"

# Generate Tab Name (First word of repo, Title Case)
raw_name="$(basename "$project_root")"
computed_tab_name="$(echo "$raw_name" | cut -d'-' -f1 | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')"
if [[ -z "$computed_tab_name" ]]; then computed_tab_name="AOC"; fi
tab_name_to_use="${tab_name:-$computed_tab_name}"

# Agent ID is just the raw repo name (used in pane name for alignment)
agent_id="$raw_name"

layout_arg="$layout_choice"
layout_path="$(resolve_layout_path "$layout_choice")"

# Process layout file if it exists (for ALL layouts, not just "aoc")
if [[ -f "$layout_path" ]]; then
  layout_label="$(sanitize_name "$(basename "$layout_choice")")"
  layout_tmp="$state_dir/aoc-layout-${layout_label}-${agent_id}.kdl"
  
  # Inject placeholders
  awk -v tab_name="$tab_name_to_use" \
      -v agent_id="$agent_id" \
      -v proj_root="$project_root" '
  {
    gsub(/__AOC_TAB_NAME__/, tab_name)
    gsub(/__AOC_AGENT_ID__/, agent_id)
    gsub(/__AOC_PROJECT_ROOT__/, proj_root)
    print
  }
' "$layout_path" > "$layout_tmp"
  layout_arg="$layout_tmp"
fi

realign_current_pane "$current_root"

AOC_PROJECT_ROOT="$project_root" \
  ZELLIJ_PROJECT_ROOT="$project_root" \
  zellij action new-tab --layout "$layout_arg" "${args[@]}"
