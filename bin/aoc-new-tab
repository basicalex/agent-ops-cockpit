#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: aoc-new-tab [--aoc|--default] [--name NAME] [--cwd PATH]

Create a new Zellij tab. Prompts for layout if not specified.
EOF
}

layout_choice=""
tab_name=""
tab_cwd=""
state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"
project_root_file="${AOC_PROJECT_ROOT_FILE:-$state_dir/project_root}"
star_file="${AOC_STAR_FILE:-$state_dir/starred_root}"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --aoc) layout_choice="aoc" ;;
    --default) layout_choice="default" ;;
    --name)
      shift
      tab_name="${1:-}"
      ;;
    --cwd)
      shift
      tab_cwd="${1:-}"
      ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown option: $1" >&2; usage; exit 1 ;;
  esac
  shift || true
done

if [[ -z "$layout_choice" ]]; then
  layout_choice="aoc"
fi

args=()
if [[ -n "$tab_name" ]]; then
  args+=(--name "$tab_name")
fi
if [[ -n "$tab_cwd" ]]; then
  args+=(--cwd "$tab_cwd")
else
  args+=(--cwd "$PWD")
fi

project_root="${tab_cwd:-$PWD}"
mkdir -p "$state_dir"
printf '%s\n' "$project_root" > "$project_root_file"
printf '%s\n' "$project_root" > "$star_file"

if [[ "$layout_choice" == "aoc" ]]; then
  AOC_PROJECT_ROOT="$project_root" \
    AOC_PROJECT_ROOT_FILE="$project_root_file" \
    ZELLIJ_PROJECT_ROOT="$project_root" \
    zellij action new-tab --layout aoc "${args[@]}"
else
  AOC_PROJECT_ROOT="$project_root" \
    AOC_PROJECT_ROOT_FILE="$project_root_file" \
    ZELLIJ_PROJECT_ROOT="$project_root" \
    zellij action new-tab "${args[@]}"
fi
