#!/usr/bin/env bash
set -euo pipefail

if [[ -z "${ZELLIJ_SESSION_NAME:-}" ]]; then
  echo "Not running inside a Zellij session." >&2
  exit 1
fi

caller_pane_id="${ZELLIJ_PANE_ID:-}"

pane_name="${AOC_CONTROL_PANE_NAME:-Control}"
width="${AOC_CONTROL_WIDTH:-70%}"
height="${AOC_CONTROL_HEIGHT:-70%}"
x="${AOC_CONTROL_X:-15%}"
y="${AOC_CONTROL_Y:-15%}"
pinned="${AOC_CONTROL_PINNED:-true}"
control_bin="${AOC_CONTROL_BIN:-aoc-control}"
open_mode="${AOC_CONTROL_TOGGLE_OPEN_MODE:-inplace}"

if ! command -v "$control_bin" >/dev/null 2>&1; then
  script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  if [[ -x "$script_dir/aoc-control" ]]; then
    control_bin="$script_dir/aoc-control"
  fi
fi

layout="$(zellij action dump-layout 2>/dev/null || true)"

floating_hidden="0"
if command -v awk >/dev/null 2>&1; then
  floating_hidden=$(printf '%s\n' "$layout" | awk '
    /tab .*focus=true/ {
      if (index($0, "hide_floating_panes=true") > 0) {
        print 1
      } else {
        print 0
      }
      exit
    }
    END {
      if (NR == 0) {
        print 0
      }
    }
  ')
fi

if [[ "$floating_hidden" == "1" ]]; then
  zellij action toggle-floating-panes >/dev/null 2>&1 || true
  layout="$(zellij action dump-layout 2>/dev/null || true)"
fi

has_control="0"
if command -v awk >/dev/null 2>&1; then
  has_control=$(printf '%s\n' "$layout" | awk -v target="$pane_name" '
    /^[[:space:]]*pane / {
      if (index($0, "name=\"" target "\"") > 0) {
        found = 1
      }
      if ($0 ~ /command=\"[^\"]*aoc-control([^\"]*)\"/) {
        found = 1
      }
    }
    END { print found + 0 }
  ')
fi

if [[ "$has_control" == "0" ]] && printf '%s' "$layout" | grep -Eq "name=\"$pane_name\"|command=\"[^\"]*aoc-control([^\"]*)\""; then
  has_control="1"
fi

if [[ "$has_control" == "1" ]]; then
  exit 0
fi

drain_tty_input() {
  if [[ ! -t 0 ]]; then
    return
  fi
  local _discard
  while IFS= read -r -s -n 1 -t 0.005 _discard; do
    :
  done
}

if [[ "$open_mode" != "new-pane" ]]; then
  drain_tty_input
  export AOC_CONTROL_NO_FLOAT=1
  export AOC_CONTROL_FLOATING_ACTIVE=1
  exec "$control_bin"
fi

close_pane_flag="${AOC_CONTROL_CLOSE_PANE:-}"
if [[ -z "$close_pane_flag" ]]; then
  if [[ -n "${ZELLIJ:-}" || -n "${ZELLIJ_SESSION_NAME:-}" ]]; then
    close_pane_flag="1"
  else
    close_pane_flag="0"
  fi
fi
if [[ "${AOC_CONTROL_TOGGLE_NO_CLOSE:-}" == "1" ]]; then
  close_pane_flag="0"
fi

zellij action new-pane \
  --floating \
  --name "$pane_name" \
  --width "$width" \
  --height "$height" \
  --x "$x" \
  --y "$y" \
  --pinned "$pinned" \
  -- bash -lc "export PATH=\"$HOME/.local/bin:$HOME/.cargo/bin:$PATH\"; export AOC_CONTROL_NO_FLOAT=1; export AOC_CONTROL_FLOATING_ACTIVE=1; exec \"$control_bin\""

if [[ "$close_pane_flag" == "1" ]]; then
  if [[ -n "$caller_pane_id" ]]; then
    zellij action close-pane --pane-id "$caller_pane_id" >/dev/null 2>&1 || true
  else
    zellij action focus-previous-pane >/dev/null 2>&1 || true
    zellij action close-pane >/dev/null 2>&1 || true
  fi
fi
