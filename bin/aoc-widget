#!/usr/bin/env bash
set -euo pipefail

STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"
ASSET="${STATE_DIR}/widget_asset"
MODE_FILE="${STATE_DIR}/widget_mode"
mkdir -p "$(dirname "$ASSET")"
touch "$ASSET"

have() { command -v "$1" >/dev/null 2>&1; }

mode="cal"
if [[ -f "$MODE_FILE" ]]; then
  saved="$(cat "$MODE_FILE" 2>/dev/null || true)"
  if [[ "$saved" == "cal" || "$saved" == "media" ]]; then
    mode="$saved"
  fi
fi

set_mode() {
  mode="$1"
  echo "$mode" > "$MODE_FILE"
}

set_media_path() {
  printf "\nPath> "
  read -r path
  if [[ -z "$path" ]]; then
    return
  fi
  if [[ ! -e "$path" ]]; then
    echo "Path not found: $path"
    sleep 1
    return
  fi
  echo "$path" > "$ASSET"
}

while true; do
  clear
  echo "AOC Widget   [c] calendar  [m] media  [p] set media path  [q] quit"
  echo "---------------------------------------------------------------"

  if [[ "$mode" == "cal" ]]; then
    date
    echo
    cal -3
    read -rsn1 k || true
    case "$k" in
      m) set_mode "media" ;;
      p) set_media_path ;;
      q) exit 0 ;;
      c) : ;;
    esac
  else
    path="$(cat "$ASSET" || true)"
    if [[ -z "$path" || ! -e "$path" ]]; then
      echo "No media set or path missing."
      echo "Press [p] to set a path."
      read -rsn1 k || true
      case "$k" in
        p) set_media_path ;;
        c) set_mode "cal" ;;
        q) exit 0 ;;
      esac
      continue
    fi

    case "$path" in
      *.mp4|*.webm|*.mov|*.gif)
        if ! have ffmpeg || ! have chafa; then
          echo "Missing ffmpeg or chafa for video rendering."
        else
          ffmpeg -loglevel quiet -i "$path" -vf "fps=12,scale=640:-1" -f image2pipe -vcodec png - \
            | chafa --animate --size=30x16 - ;;
        fi
        ;;
      *.png|*.jpg|*.jpeg|*.webp)
        if ! have chafa; then
          echo "Missing chafa for image rendering."
        else
          chafa --size=30x16 "$path"
        fi
        ;;
      *.svg)
        tmp="/tmp/aoc_widget.png"
        if ! have rsvg-convert || ! have chafa; then
          echo "Missing rsvg-convert or chafa for SVG rendering."
        else
          rsvg-convert "$path" -o "$tmp" >/dev/null 2>&1 || true
          if [[ -f "$tmp" ]]; then
            chafa --size=30x16 "$tmp"
          else
            echo "SVG render failed."
          fi
        fi
        ;;
      *)
        echo "Unsupported: $path"
        ;;
    esac

    read -rsn1 k || true
    case "$k" in
      c) set_mode "cal" ;;
      p) set_media_path ;;
      q) exit 0 ;;
      m) : ;;
    esac
  fi
done
