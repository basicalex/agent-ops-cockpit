#!/usr/bin/env bash
set -euo pipefail

STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"
GLOBAL_WIDGET_DIR="${STATE_DIR}/widget"
LEGACY_GLOBAL_DIR="${STATE_DIR}"

project_root=""
if command -v aoc-align >/dev/null 2>&1; then
  project_root="$(aoc-align --print-root 2>/dev/null || true)"
fi
if [[ -z "$project_root" ]]; then
  project_root="$PWD"
fi
project_root="$(cd "$project_root" 2>/dev/null && pwd -P || echo "$project_root")"

project_id_source=""
if command -v git >/dev/null 2>&1; then
  if git -C "$project_root" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    project_id_source="$(git -C "$project_root" config --get remote.origin.url 2>/dev/null || true)"
    if [[ -z "$project_id_source" ]]; then
      project_id_source="$(git -C "$project_root" remote get-url origin 2>/dev/null || true)"
    fi
  fi
fi
if [[ -z "$project_id_source" ]]; then
  project_id_source="$project_root"
fi

if command -v cksum >/dev/null 2>&1; then
  project_key="$(printf "%s" "$project_id_source" | cksum | awk '{print $1}')"
else
  project_key="$(printf "%s" "$project_id_source" | tr '/:' '__' | tr -cd '[:alnum:]_-')"
fi
if [[ -z "$project_key" ]]; then
  project_key="default"
fi

PROJECT_WIDGET_DIR="${GLOBAL_WIDGET_DIR}/projects/${project_key}"
mkdir -p "$STATE_DIR"
mkdir -p "$GLOBAL_WIDGET_DIR"
mkdir -p "$PROJECT_WIDGET_DIR"

MODE_FILE="${PROJECT_WIDGET_DIR}/widget_mode"
MEDIA_ASSET_FILE="${PROJECT_WIDGET_DIR}/widget_media_asset"
LEGACY_MEDIA_ASSET_FILE="${PROJECT_WIDGET_DIR}/widget_asset"
MEDIA_VIEW_FILE="${PROJECT_WIDGET_DIR}/widget_media_view"
MEDIA_STYLE_FILE="${PROJECT_WIDGET_DIR}/widget_media_style"
MEDIA_SIZE_FILE="${PROJECT_WIDGET_DIR}/widget_media_scale"
MEDIA_DETAIL_FILE="${PROJECT_WIDGET_DIR}/widget_media_detail"
MEDIA_COLOR_FILE="${PROJECT_WIDGET_DIR}/widget_media_colors"
MEDIA_DITHER_FILE="${PROJECT_WIDGET_DIR}/widget_media_dither"
MEDIA_RATIO_FILE="${PROJECT_WIDGET_DIR}/widget_media_font_ratio"
MEDIA_OFFSET_X_FILE="${PROJECT_WIDGET_DIR}/widget_media_offset_x"
MEDIA_OFFSET_Y_FILE="${PROJECT_WIDGET_DIR}/widget_media_offset_y"

GLOBAL_MEDIA_STYLE_FILE="${GLOBAL_WIDGET_DIR}/widget_media_style"
GLOBAL_MEDIA_SIZE_FILE="${GLOBAL_WIDGET_DIR}/widget_media_scale"
GLOBAL_MEDIA_DETAIL_FILE="${GLOBAL_WIDGET_DIR}/widget_media_detail"
GLOBAL_MEDIA_COLOR_FILE="${GLOBAL_WIDGET_DIR}/widget_media_colors"
GLOBAL_MEDIA_DITHER_FILE="${GLOBAL_WIDGET_DIR}/widget_media_dither"
GLOBAL_MEDIA_RATIO_FILE="${GLOBAL_WIDGET_DIR}/widget_media_font_ratio"
GLOBAL_MEDIA_OFFSET_X_FILE="${GLOBAL_WIDGET_DIR}/widget_media_offset_x"
GLOBAL_MEDIA_OFFSET_Y_FILE="${GLOBAL_WIDGET_DIR}/widget_media_offset_y"

GALLERY_INDEX_FILE="${GLOBAL_WIDGET_DIR}/widget_gallery_index"
GALLERY_VIEW_FILE="${GLOBAL_WIDGET_DIR}/widget_gallery_view"
GALLERY_STYLE_FILE="${GLOBAL_WIDGET_DIR}/widget_style"
GALLERY_SIZE_FILE="${GLOBAL_WIDGET_DIR}/widget_scale"
GALLERY_DETAIL_FILE="${GLOBAL_WIDGET_DIR}/widget_detail"
GALLERY_COLOR_FILE="${GLOBAL_WIDGET_DIR}/widget_colors"
GALLERY_DITHER_FILE="${GLOBAL_WIDGET_DIR}/widget_dither"
GALLERY_RATIO_FILE="${GLOBAL_WIDGET_DIR}/widget_font_ratio"
GALLERY_OFFSET_X_FILE="${GLOBAL_WIDGET_DIR}/widget_offset_x"
GALLERY_OFFSET_Y_FILE="${GLOBAL_WIDGET_DIR}/widget_offset_y"

GALLERY_DIR="${AOC_WIDGET_GALLERY_DIR:-$HOME/Pictures/Zellij}"
CHAFa_SYMBOLS="${AOC_WIDGET_SYMBOLS:-}"
CHAFa_COLORS="${AOC_WIDGET_COLORS:-}"
CHAFa_DITHER="${AOC_WIDGET_DITHER:-}"
CHAFa_SCALE="${AOC_WIDGET_SCALE:-}"
CHAFa_WORK="${AOC_WIDGET_WORK:-}"
CHAFa_FONT_RATIO="${AOC_WIDGET_FONT_RATIO:-}"

have() { command -v "$1" >/dev/null 2>&1; }

mode="gallery"
  if [[ -f "$MODE_FILE" ]]; then
    saved="$(cat "$MODE_FILE" 2>/dev/null || true)"
    if [[ "$saved" == "media" || "$saved" == "gallery" || "$saved" == "blank" ]]; then
      mode="$saved"
    fi
  fi

  gallery_view="$(load_gallery_setting "$GALLERY_VIEW_FILE" "0")"
  media_view="$(load_media_setting "$MEDIA_VIEW_FILE" "0")"
  if ! [[ "$gallery_view" =~ ^[0-9]+$ ]]; then gallery_view=0; fi
  if ! [[ "$media_view" =~ ^[0-9]+$ ]] || [[ "$media_view" != "0" && "$media_view" != "1" ]]; then media_view=0; fi

today_year="$(date +%Y)"
today_month="$(date +%m)"
today_day="$(date +%d)"
view_year="$today_year"
view_month="$today_month"
gallery_index=0
gallery_count=0
gallery_stat="0"
gallery_view=0
last_gallery_view=0
media_view=0
last_media_view=0
declare -a gallery_files=()
declare -a style_presets=(
  "ascii"
  "ascii+stipple"
  "ascii+dot"
  "ascii+diagonal"
  "ascii+geometric"
  "ascii+half"
)
declare -a color_presets=("16" "256" "full" "none")
declare -a dither_presets=("ordered" "diffusion" "none")
declare -a work_presets=("1" "3" "5" "7" "9")
style_index=0
color_index=0
dither_index=0
work_index=0
offset_x=0
offset_y=0
ratio_edit=0
ratio_edit_w=1
ratio_edit_h=2
ratio_override=""

adjust_offset() {
  local dx="$1"
  local dy="$2"
  local cols
  local lines

  cols="$(tput cols 2>/dev/null || echo 30)"
  lines="$(tput lines 2>/dev/null || echo 16)"
  local max_x=$((cols - 10))
  local max_y=$((lines - 6))
  if (( max_x < 0 )); then max_x=0; fi
  if (( max_y < 0 )); then max_y=0; fi

  offset_x=$((offset_x + dx))
  offset_y=$((offset_y + dy))
  if (( offset_x < 0 )); then offset_x=0; fi
  if (( offset_y < 0 )); then offset_y=0; fi
  if (( offset_x > max_x )); then offset_x="$max_x"; fi
  if (( offset_y > max_y )); then offset_y="$max_y"; fi

  save_setting "$ACTIVE_OFFSET_X_FILE" "$offset_x"
  save_setting "$ACTIVE_OFFSET_Y_FILE" "$offset_y"
}

set_mode() {
  mode="$1"
  echo "$mode" > "$MODE_FILE"
}

load_gallery_setting() {
  local file="$1"
  local default="$2"
  if [[ -f "$file" ]]; then
    cat "$file" 2>/dev/null || echo "$default"
    return
  fi
  local base
  base="$(basename "$file")"
  local legacy_file="${LEGACY_GLOBAL_DIR}/${base}"
  if [[ -f "$legacy_file" ]]; then
    cat "$legacy_file" 2>/dev/null || echo "$default"
  else
    echo "$default"
  fi
}

load_media_setting() {
  local file="$1"
  local default="$2"
  if [[ -f "$file" ]]; then
    cat "$file" 2>/dev/null || echo "$default"
    return
  fi
  local base
  base="$(basename "$file")"
  local global_file="${GLOBAL_WIDGET_DIR}/${base}"
  if [[ -f "$global_file" ]]; then
    cat "$global_file" 2>/dev/null || echo "$default"
  else
    echo "$default"
  fi
}

load_active_setting() {
  if [[ "$mode" == "media" ]]; then
    load_media_setting "$@"
  else
    load_gallery_setting "$@"
  fi
}

save_setting() {
  local file="$1"
  local value="$2"
  mkdir -p "$(dirname "$file")"
  echo "$value" > "$file"
}

sync_index() {
  local value="$1"
  shift
  local -a options=("$@")
  local i
  for i in "${!options[@]}"; do
    if [[ "${options[$i]}" == "$value" ]]; then
      echo "$i"
      return
    fi
  done
  echo "0"
}

migrate_file() {
  local target="$1"
  local source="$2"
  if [[ ! -f "$target" && -f "$source" ]]; then
    cp "$source" "$target"
  fi
}

migrate_project_media_settings() {
  migrate_file "$MEDIA_ASSET_FILE" "$LEGACY_MEDIA_ASSET_FILE"
  migrate_file "$MEDIA_STYLE_FILE" "${PROJECT_WIDGET_DIR}/widget_style"
  migrate_file "$MEDIA_SIZE_FILE" "${PROJECT_WIDGET_DIR}/widget_scale"
  migrate_file "$MEDIA_DETAIL_FILE" "${PROJECT_WIDGET_DIR}/widget_detail"
  migrate_file "$MEDIA_COLOR_FILE" "${PROJECT_WIDGET_DIR}/widget_colors"
  migrate_file "$MEDIA_DITHER_FILE" "${PROJECT_WIDGET_DIR}/widget_dither"
  migrate_file "$MEDIA_RATIO_FILE" "${PROJECT_WIDGET_DIR}/widget_font_ratio"
  migrate_file "$MEDIA_OFFSET_X_FILE" "${PROJECT_WIDGET_DIR}/widget_offset_x"
  migrate_file "$MEDIA_OFFSET_Y_FILE" "${PROJECT_WIDGET_DIR}/widget_offset_y"
}

normalize_media_path() {
  local input="$1"
  if [[ -z "$input" ]]; then
    echo ""
    return
  fi
  if [[ "$input" == /* || "$input" =~ ^[A-Za-z]:[/\\] ]]; then
    echo "$input"
    return
  fi
  echo "$project_root/$input"
}

format_media_path() {
  local abs="$1"
  if [[ -n "$project_root" && "$abs" == "$project_root"/* ]]; then
    echo "${abs#$project_root/}"
  else
    echo "$abs"
  fi
}

migrate_project_media_settings

if [[ -f "$MEDIA_ASSET_FILE" ]]; then
  media_asset_raw="$(cat "$MEDIA_ASSET_FILE" 2>/dev/null || true)"
  if [[ -n "$media_asset_raw" ]]; then
    media_asset_abs="$(normalize_media_path "$media_asset_raw")"
    if [[ -n "$media_asset_abs" && "$media_asset_abs" == "$project_root"/* ]]; then
      rel_media_asset="$(format_media_path "$media_asset_abs")"
      if [[ -n "$rel_media_asset" && "$rel_media_asset" != "$media_asset_raw" ]]; then
        echo "$rel_media_asset" > "$MEDIA_ASSET_FILE"
      fi
    fi
  fi
fi

ACTIVE_STYLE_FILE=""
ACTIVE_SIZE_FILE=""
ACTIVE_DETAIL_FILE=""
ACTIVE_COLOR_FILE=""
ACTIVE_DITHER_FILE=""
ACTIVE_RATIO_FILE=""
ACTIVE_OFFSET_X_FILE=""
ACTIVE_OFFSET_Y_FILE=""
active_mode=""

gallery_index="$(load_gallery_setting "$GALLERY_INDEX_FILE" "0")"
gallery_view="$(load_gallery_setting "$GALLERY_VIEW_FILE" "0")"
media_view="$(load_media_setting "$MEDIA_VIEW_FILE" "0")"
if ! [[ "$gallery_index" =~ ^[0-9]+$ ]]; then gallery_index=0; fi
if ! [[ "$gallery_view" =~ ^[0-9]+$ ]]; then gallery_view=0; fi
if ! [[ "$media_view" =~ ^[0-9]+$ ]] || [[ "$media_view" != "0" && "$media_view" != "1" ]]; then media_view=0; fi

load_mode_settings() {
  local target="$1"
  if [[ "$target" == "media" ]]; then
    ACTIVE_STYLE_FILE="$MEDIA_STYLE_FILE"
    ACTIVE_SIZE_FILE="$MEDIA_SIZE_FILE"
    ACTIVE_DETAIL_FILE="$MEDIA_DETAIL_FILE"
    ACTIVE_COLOR_FILE="$MEDIA_COLOR_FILE"
    ACTIVE_DITHER_FILE="$MEDIA_DITHER_FILE"
    ACTIVE_RATIO_FILE="$MEDIA_RATIO_FILE"
    ACTIVE_OFFSET_X_FILE="$MEDIA_OFFSET_X_FILE"
    ACTIVE_OFFSET_Y_FILE="$MEDIA_OFFSET_Y_FILE"
    style_index="$(sync_index "$(load_media_setting "$MEDIA_STYLE_FILE" "ascii")" "${style_presets[@]}")"
    color_index="$(sync_index "$(load_media_setting "$MEDIA_COLOR_FILE" "16")" "${color_presets[@]}")"
    dither_index="$(sync_index "$(load_media_setting "$MEDIA_DITHER_FILE" "ordered")" "${dither_presets[@]}")"
    work_index="$(sync_index "$(load_media_setting "$MEDIA_DETAIL_FILE" "5")" "${work_presets[@]}")"
    offset_x="$(load_media_setting "$MEDIA_OFFSET_X_FILE" "0")"
    offset_y="$(load_media_setting "$MEDIA_OFFSET_Y_FILE" "0")"
  else
    ACTIVE_STYLE_FILE="$GALLERY_STYLE_FILE"
    ACTIVE_SIZE_FILE="$GALLERY_SIZE_FILE"
    ACTIVE_DETAIL_FILE="$GALLERY_DETAIL_FILE"
    ACTIVE_COLOR_FILE="$GALLERY_COLOR_FILE"
    ACTIVE_DITHER_FILE="$GALLERY_DITHER_FILE"
    ACTIVE_RATIO_FILE="$GALLERY_RATIO_FILE"
    ACTIVE_OFFSET_X_FILE="$GALLERY_OFFSET_X_FILE"
    ACTIVE_OFFSET_Y_FILE="$GALLERY_OFFSET_Y_FILE"
    style_index="$(sync_index "$(load_gallery_setting "$GALLERY_STYLE_FILE" "ascii")" "${style_presets[@]}")"
    color_index="$(sync_index "$(load_gallery_setting "$GALLERY_COLOR_FILE" "16")" "${color_presets[@]}")"
    dither_index="$(sync_index "$(load_gallery_setting "$GALLERY_DITHER_FILE" "ordered")" "${dither_presets[@]}")"
    work_index="$(sync_index "$(load_gallery_setting "$GALLERY_DETAIL_FILE" "5")" "${work_presets[@]}")"
    offset_x="$(load_gallery_setting "$GALLERY_OFFSET_X_FILE" "0")"
    offset_y="$(load_gallery_setting "$GALLERY_OFFSET_Y_FILE" "0")"
  fi

  if ! [[ "$offset_x" =~ ^[0-9]+$ ]]; then offset_x=0; fi
  if ! [[ "$offset_y" =~ ^[0-9]+$ ]]; then offset_y=0; fi
}

load_mode_settings "$mode"
active_mode="$mode"

render_header() {
  echo "AOC Widget   [m] media  [g] gallery  [p] set media path  [G] save defaults  [R] reset  [q] quit"
  echo "---------------------------------------------------------------"
}

set_pane_title() {
  printf "\033]0;%s\007" "$1"
}

render_blank() {
  set_pane_title "Widget [Idle]"
  render_header
  echo
  echo "Widget idle. Press [m] for media or [g] for gallery."
  echo
  echo "[s] style  [C] colors  [D] dither  [w] detail  [r] ratio  [+/-] size"
}

render_media() {
  local path="$1"
  local offset_x="${2:-0}"
  local offset_y="${3:-0}"
  local cols
  local lines

  cols="$(tput cols 2>/dev/null || echo 30)"
  lines="$(tput lines 2>/dev/null || echo 16)"
  local scale="$CHAFa_SCALE"
  if [[ -z "$scale" ]]; then
    scale="$(load_active_setting "$ACTIVE_SIZE_FILE" "1.0")"
  fi
  local work="$CHAFa_WORK"
  if [[ -z "$work" ]]; then
    work="$(load_active_setting "$ACTIVE_DETAIL_FILE" "5")"
  fi
  local symbols="$CHAFa_SYMBOLS"
  if [[ -z "$symbols" ]]; then
    symbols="$(load_active_setting "$ACTIVE_STYLE_FILE" "ascii")"
  fi
  local colors="$CHAFa_COLORS"
  if [[ -z "$colors" ]]; then
    colors="$(load_active_setting "$ACTIVE_COLOR_FILE" "16")"
  fi
  local dither="$CHAFa_DITHER"
  if [[ -z "$dither" ]]; then
    dither="$(load_active_setting "$ACTIVE_DITHER_FILE" "ordered")"
  fi
  local font_ratio="$CHAFa_FONT_RATIO"
  if [[ -z "$font_ratio" ]]; then
    font_ratio="$(load_active_setting "$ACTIVE_RATIO_FILE" "1/2")"
  fi
  if [[ -n "$ratio_override" ]]; then
    font_ratio="$ratio_override"
  fi

  local out_cols out_lines
  out_cols="$(python3 - <<PY
import math
cols=float("$cols")
scale=float("$scale")
print(max(10, int(math.floor(cols*scale))))
PY
)"
  out_lines="$(python3 - <<PY
import math
lines=float("$lines")
scale=float("$scale")
print(max(6, int(math.floor(lines*scale))))
PY
)"

  local chafa_args=(--size "${out_cols}x${out_lines}" --symbols "$symbols" --colors "$colors" --dither "$dither" --fg-only --work "$work")
  if [[ -n "$font_ratio" ]]; then
    chafa_args+=(--font-ratio "$font_ratio")
  fi

  render_pad() {
    local ox="$1"
    local oy="$2"
    local i
    for ((i=0; i<oy; i++)); do
      printf "\n"
    done
    while IFS= read -r line; do
      printf "%*s%s\n" "$ox" "" "$line"
    done
  }

  if [[ -z "$path" || ! -e "$path" ]]; then
    echo "No media set or path missing."
    echo "Press [p] to set a path."
    return
  fi

  case "$path" in
    *.mp4|*.webm|*.mov|*.gif)
      if ! have ffmpeg || ! have chafa; then
        echo "Missing ffmpeg or chafa for video rendering."
      else
        if (( offset_x > 0 || offset_y > 0 )); then
          chafa_args+=(--animate off)
          ffmpeg -loglevel quiet -i "$path" -vf "fps=12,scale=640:-1" -f image2pipe -vcodec png - \
            | chafa "${chafa_args[@]}" - \
            | render_pad "$offset_x" "$offset_y"
        else
          chafa_args+=(--animate on)
          ffmpeg -loglevel quiet -i "$path" -vf "fps=12,scale=640:-1" -f image2pipe -vcodec png - \
            | chafa "${chafa_args[@]}" -
        fi
      fi
      ;;
    *.png|*.jpg|*.jpeg|*.webp)
      if ! have chafa; then
        echo "Missing chafa for image rendering."
      else
        if (( offset_x > 0 || offset_y > 0 )); then
          chafa "${chafa_args[@]}" "$path" | render_pad "$offset_x" "$offset_y"
        else
          chafa "${chafa_args[@]}" "$path"
        fi
      fi
      ;;
    *.svg)
      tmp="/tmp/aoc_widget.png"
      if ! have rsvg-convert || ! have chafa; then
        echo "Missing rsvg-convert or chafa for SVG rendering."
      else
        rsvg-convert "$path" -o "$tmp" >/dev/null 2>&1 || true
        if [[ -f "$tmp" ]]; then
          if (( offset_x > 0 || offset_y > 0 )); then
            chafa "${chafa_args[@]}" "$tmp" | render_pad "$offset_x" "$offset_y"
          else
            chafa "${chafa_args[@]}" "$tmp"
          fi
        else
          echo "SVG render failed."
        fi
      fi
      ;;
    *)
      echo "Unsupported: $path"
      ;;
  esac
}

render_calendar() {
  if ! have python3; then
    echo "Missing python3 for calendar rendering."
    return
  fi

  VIEW_YEAR="$view_year" VIEW_MONTH="$view_month" TODAY_YEAR="$today_year" TODAY_MONTH="$today_month" TODAY_DAY="$today_day" \
    python3 - <<'PY'
import calendar
import os

year = int(os.environ["VIEW_YEAR"])
month = int(os.environ["VIEW_MONTH"])
today_year = int(os.environ["TODAY_YEAR"])
today_month = int(os.environ["TODAY_MONTH"])
today_day = int(os.environ["TODAY_DAY"])

cal = calendar.Calendar(firstweekday=calendar.SUNDAY)
month_name = calendar.month_name[month]
header = f"{month_name} {year}"
width = 28
print(header.center(width))
print(" Su  Mo  Tu  We  Th  Fr  Sa")

for week in cal.monthdayscalendar(year, month):
    cells = []
    for day in week:
        if day == 0:
            cells.append("    ")
        elif year == today_year and month == today_month and day == today_day:
            cells.append(f"[{day:2d}]")
        else:
            cells.append(f" {day:2d} ")
    print("".join(cells))
PY
}

load_gallery_files() {
  gallery_files=()
  if [[ -d "$GALLERY_DIR" ]]; then
    while IFS= read -r -d '' f; do
      gallery_files+=("$f")
    done < <(
      find "$GALLERY_DIR" -maxdepth 1 -type f \( \
        -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.webp' -o -iname '*.gif' -o -iname '*.mp4' -o -iname '*.webm' -o -iname '*.mov' -o -iname '*.svg' \
      \) -print0 | sort -z
    )
  fi
  gallery_count="${#gallery_files[@]}"
  if (( gallery_count == 0 )); then
    gallery_index=0
  elif (( gallery_index >= gallery_count )); then
    gallery_index=$((gallery_count - 1))
  fi
  save_setting "$GALLERY_INDEX_FILE" "$gallery_index"
}

set_media_path() {
  printf "\nPath> "
  read -r path
  if [[ -z "$path" ]]; then
    return
  fi
  if [[ ! -e "$path" ]]; then
    echo "Path not found: $path"
    sleep 1
    return
  fi
  path="$(realpath "$path")"
  stored_path="$(format_media_path "$path")"
  echo "$stored_path" > "$MEDIA_ASSET_FILE"
  save_setting "$MEDIA_VIEW_FILE" "1"
  media_view=1
}

save_media_defaults() {
  local scale
  local ratio
  scale="$(load_media_setting "$ACTIVE_SIZE_FILE" "1.0")"
  ratio="$(load_media_setting "$ACTIVE_RATIO_FILE" "1/2")"
  save_setting "$GLOBAL_MEDIA_STYLE_FILE" "${style_presets[$style_index]}"
  save_setting "$GLOBAL_MEDIA_COLOR_FILE" "${color_presets[$color_index]}"
  save_setting "$GLOBAL_MEDIA_DITHER_FILE" "${dither_presets[$dither_index]}"
  save_setting "$GLOBAL_MEDIA_DETAIL_FILE" "${work_presets[$work_index]}"
  save_setting "$GLOBAL_MEDIA_SIZE_FILE" "$scale"
  save_setting "$GLOBAL_MEDIA_RATIO_FILE" "$ratio"
  save_setting "$GLOBAL_MEDIA_OFFSET_X_FILE" "$offset_x"
  save_setting "$GLOBAL_MEDIA_OFFSET_Y_FILE" "$offset_y"
}

save_gallery_defaults() {
  local scale
  local ratio
  scale="$(load_gallery_setting "$ACTIVE_SIZE_FILE" "1.0")"
  ratio="$(load_gallery_setting "$ACTIVE_RATIO_FILE" "1/2")"
  save_setting "$GALLERY_STYLE_FILE" "${style_presets[$style_index]}"
  save_setting "$GALLERY_COLOR_FILE" "${color_presets[$color_index]}"
  save_setting "$GALLERY_DITHER_FILE" "${dither_presets[$dither_index]}"
  save_setting "$GALLERY_DETAIL_FILE" "${work_presets[$work_index]}"
  save_setting "$GALLERY_SIZE_FILE" "$scale"
  save_setting "$GALLERY_RATIO_FILE" "$ratio"
  save_setting "$GALLERY_OFFSET_X_FILE" "$offset_x"
  save_setting "$GALLERY_OFFSET_Y_FILE" "$offset_y"
  save_setting "$GALLERY_INDEX_FILE" "$gallery_index"
  save_setting "$GALLERY_VIEW_FILE" "$gallery_view"
}

reset_media_settings() {
  rm -f "$MEDIA_ASSET_FILE" "$LEGACY_MEDIA_ASSET_FILE"
  rm -f "$MEDIA_STYLE_FILE" "$MEDIA_COLOR_FILE" "$MEDIA_DITHER_FILE" "$MEDIA_DETAIL_FILE" \
    "$MEDIA_SIZE_FILE" "$MEDIA_RATIO_FILE" "$MEDIA_OFFSET_X_FILE" "$MEDIA_OFFSET_Y_FILE" \
    "$MEDIA_VIEW_FILE"
  rm -f "$MODE_FILE"
  media_view=0
  mode="gallery"
  load_mode_settings "gallery"
  active_mode="gallery"
}

reset_gallery_settings() {
  rm -f "$GALLERY_STYLE_FILE" "$GALLERY_COLOR_FILE" "$GALLERY_DITHER_FILE" "$GALLERY_DETAIL_FILE" \
    "$GALLERY_SIZE_FILE" "$GALLERY_RATIO_FILE" "$GALLERY_OFFSET_X_FILE" "$GALLERY_OFFSET_Y_FILE" \
    "$GALLERY_INDEX_FILE" "$GALLERY_VIEW_FILE"
  rm -f "${LEGACY_GLOBAL_DIR}/widget_style" "${LEGACY_GLOBAL_DIR}/widget_colors" \
    "${LEGACY_GLOBAL_DIR}/widget_dither" "${LEGACY_GLOBAL_DIR}/widget_detail" \
    "${LEGACY_GLOBAL_DIR}/widget_scale" "${LEGACY_GLOBAL_DIR}/widget_font_ratio" \
    "${LEGACY_GLOBAL_DIR}/widget_offset_x" "${LEGACY_GLOBAL_DIR}/widget_offset_y" \
    "${LEGACY_GLOBAL_DIR}/widget_gallery_index" "${LEGACY_GLOBAL_DIR}/widget_gallery_view"
  gallery_index=0
  gallery_view=0
  load_mode_settings "gallery"
}

last_mode=""
last_path=""
last_minute=""
force_redraw=1
last_gallery_stat=""

while true; do
  today_year="$(date +%Y)"
  today_month="$(date +%m)"
  today_day="$(date +%d)"

  if [[ -f "$MODE_FILE" ]]; then
    saved="$(cat "$MODE_FILE" 2>/dev/null || true)"
    if [[ "$saved" == "media" || "$saved" == "gallery" || "$saved" == "blank" ]]; then
      mode="$saved"
    fi
  fi

  project_media_path_raw=""
  if [[ -f "$MEDIA_ASSET_FILE" ]]; then
    project_media_path_raw="$(cat "$MEDIA_ASSET_FILE" 2>/dev/null || true)"
  fi
  project_media_path="$(normalize_media_path "$project_media_path_raw")"
  project_media_ready=0
  if [[ -n "$project_media_path" && -e "$project_media_path" ]]; then
    project_media_ready=1
  fi
  if [[ "$mode" == "media" && "$project_media_ready" -eq 0 ]]; then
    mode="gallery"
  fi

  if [[ "$mode" != "$active_mode" ]]; then
    load_mode_settings "$mode"
    active_mode="$mode"
  fi

  path=""
  if [[ "$mode" == "media" ]]; then
    path="$project_media_path"
  elif [[ "$mode" == "gallery" ]]; then
    gallery_stat="$(stat -c %Y "$GALLERY_DIR" 2>/dev/null || echo 0)"
    if [[ "$gallery_stat" != "$last_gallery_stat" || "${#gallery_files[@]}" -eq 0 ]]; then
      load_gallery_files
      last_gallery_stat="$gallery_stat"
      force_redraw=1
    fi
    if (( gallery_count > 0 )); then
      path="${gallery_files[$gallery_index]}"
    fi
  fi

  minute="$(date +%Y%m%d%H%M)"
  media_ready=0
  if [[ "$mode" == "media" && "$project_media_ready" -eq 1 ]]; then
    media_ready=1
  fi
  redraw=0
  if [[ "$force_redraw" -eq 1 || "$mode" != "$last_mode" || "$gallery_view" != "$last_gallery_view" || "$media_view" != "$last_media_view" ]]; then
    redraw=1
  elif [[ "$mode" == "media" && "$path" != "$last_path" ]]; then
    redraw=1
  elif [[ "$mode" == "cal" && "$minute" != "$last_minute" ]]; then
    redraw=1
  fi

  if [[ "$redraw" -eq 1 ]]; then
    clear
    case "$mode" in
      media)
        set_pane_title "Widget [Media]"
        if (( media_view == 1 && media_ready == 1 )); then
          render_media "$path" "$offset_x" "$offset_y"
        else
          render_header
          render_media "$path"
          if (( ratio_edit == 1 )); then
            echo
            echo "Ratio editor: ${ratio_edit_w}/${ratio_edit_h}  (h/l width, j/k height, Enter apply, Esc cancel)"
          fi
          echo
          echo "[Enter] clean view  [h/j/k/l or arrows] offset  [0] reset"
          echo "[s] style  [C] colors  [D] dither  [w] detail  [r] ratio  [+/-] size  [G] save defaults  [R] reset"
        fi
        ;;
      gallery)
        if (( gallery_view == 1 )); then
          set_pane_title "Widget [Gallery: $((gallery_index+1))/$gallery_count]"
          if (( gallery_count == 0 )); then
            render_blank
          else
            render_media "${gallery_files[$gallery_index]}" "$offset_x" "$offset_y"
          fi
        else
          set_pane_title "Widget [Gallery List]"
          render_header
          echo "Gallery: $GALLERY_DIR"
          if (( gallery_count == 0 )); then
            echo "No media files found."
          else
            for i in "${!gallery_files[@]}"; do
              name="$(basename "${gallery_files[$i]}")"
              if (( i == gallery_index )); then
                printf "> %2d. %s\n" "$((i + 1))" "$name"
              else
                printf "  %2d. %s\n" "$((i + 1))" "$name"
              fi
            done
            echo
            render_media "${gallery_files[$gallery_index]}"
            if (( ratio_edit == 1 )); then
              echo
              echo "Ratio editor: ${ratio_edit_w}/${ratio_edit_h}  (h/l width, j/k height, Enter apply, Esc cancel)"
            fi
            echo
            echo "[j/k] move  [1-9] jump  [Enter] view  [h/j/k/l or arrows] offset  [0] reset"
            echo "[s] style  [C] colors  [D] dither  [w] detail  [r] ratio  [+/-] size  [G] save defaults  [R] reset"
          fi
        fi
        ;;
      cal)
        set_pane_title "Widget [Calendar]"
        render_header
        render_calendar
        echo
        echo "[h/j/k/l] navigate  [t] today  [m] media  [g] gallery"
        ;;
      blank)
        render_blank
        ;;
    esac

    last_mode="$mode"
    last_path="$path"
    last_minute="$minute"
    last_gallery_view="$gallery_view"
    last_media_view="$media_view"
    force_redraw=0
  fi

  key=""
  is_enter=0
  if read -rsn1 -t 1 k; then
    if [[ "$k" == $'\e' ]]; then
      if read -rsn2 -t 0.05 k2; then
        case "$k2" in
          "[A") key="up" ;;
          "[B") key="down" ;;
          "[C") key="right" ;;
          "[D") key="left" ;;
          *) key="esc" ;;
        esac
      else
        key="esc"
      fi
    elif [[ -z "$k" ]]; then
      is_enter=1
      key="enter"
    else
      key="$k"
    fi
  fi

  handled_ratio_edit=0
  if (( ratio_edit == 1 )); then
    case "$key" in
      h)
        if (( ratio_edit_w > 1 )); then ratio_edit_w=$((ratio_edit_w - 1)); fi
        ratio_override="${ratio_edit_w}/${ratio_edit_h}"
        force_redraw=1
        handled_ratio_edit=1
        ;;
      l)
        if (( ratio_edit_w < 9 )); then ratio_edit_w=$((ratio_edit_w + 1)); fi
        ratio_override="${ratio_edit_w}/${ratio_edit_h}"
        force_redraw=1
        handled_ratio_edit=1
        ;;
      j)
        if (( ratio_edit_h < 9 )); then ratio_edit_h=$((ratio_edit_h + 1)); fi
        ratio_override="${ratio_edit_w}/${ratio_edit_h}"
        force_redraw=1
        handled_ratio_edit=1
        ;;
      k)
        if (( ratio_edit_h > 1 )); then ratio_edit_h=$((ratio_edit_h - 1)); fi
        ratio_override="${ratio_edit_w}/${ratio_edit_h}"
        force_redraw=1
        handled_ratio_edit=1
        ;;
      enter)
        save_setting "$ACTIVE_RATIO_FILE" "${ratio_edit_w}/${ratio_edit_h}"
        ratio_edit=0
        ratio_override=""
        force_redraw=1
        handled_ratio_edit=1
        ;;
    esac
  fi
  if (( handled_ratio_edit == 1 )); then
    continue
  fi
  if (( ratio_edit == 1 )); then
    case "$key" in
      ""|esc|q) ;;
      *) continue ;;
    esac
  fi

  case "$key" in
    esc)
      if (( ratio_edit == 1 )); then
        ratio_edit=0
        ratio_override=""
        force_redraw=1
      else
        set_mode "blank"
        force_redraw=1
      fi
      ;;
    m)
      set_mode "media"
      mode="media"
      media_view="$(load_media_setting "$MEDIA_VIEW_FILE" "0")"
      if ! [[ "$media_view" =~ ^[0-9]+$ ]] || [[ "$media_view" != "0" && "$media_view" != "1" ]]; then media_view=0; fi
      load_mode_settings "$mode"
      active_mode="$mode"
      force_redraw=1
      ;;
    g)
      set_mode "gallery"
      mode="gallery"
      gallery_view="$(load_gallery_setting "$GALLERY_VIEW_FILE" "0")"
      load_mode_settings "$mode"
      active_mode="$mode"
      force_redraw=1
      ;;
    p)
      set_media_path
      set_mode "media"
      mode="media"
      load_mode_settings "$mode"
      active_mode="$mode"
      force_redraw=1
      ;;
    G)
      if [[ "$mode" == "media" ]]; then
        save_media_defaults
      else
        save_gallery_defaults
      fi
      force_redraw=1
      ;;
    R)
      if [[ "$mode" == "media" ]]; then
        reset_media_settings
      else
        reset_gallery_settings
      fi
      force_redraw=1
      ;;
    q) exit 0 ;;
    s)
      style_index=$(((style_index + 1) % ${#style_presets[@]}))
      save_setting "$ACTIVE_STYLE_FILE" "${style_presets[$style_index]}"
      force_redraw=1
      ;;
    C)
      color_index=$(((color_index + 1) % ${#color_presets[@]}))
      save_setting "$ACTIVE_COLOR_FILE" "${color_presets[$color_index]}"
      force_redraw=1
      ;;
    D)
      dither_index=$(((dither_index + 1) % ${#dither_presets[@]}))
      save_setting "$ACTIVE_DITHER_FILE" "${dither_presets[$dither_index]}"
      force_redraw=1
      ;;
    w)
      work_index=$(((work_index + 1) % ${#work_presets[@]}))
      save_setting "$ACTIVE_DETAIL_FILE" "${work_presets[$work_index]}"
      force_redraw=1
      ;;
    r)
      if (( ratio_edit == 0 )); then
        ratio_edit=1
        saved_ratio="$(load_active_setting "$ACTIVE_RATIO_FILE" "1/2")"
        ratio_edit_w="${saved_ratio%%/*}"
        ratio_edit_h="${saved_ratio##*/}"
        if ! [[ "$ratio_edit_w" =~ ^[0-9]+$ ]]; then ratio_edit_w=1; fi
        if ! [[ "$ratio_edit_h" =~ ^[0-9]+$ ]]; then ratio_edit_h=2; fi
        if (( ratio_edit_w < 1 )); then ratio_edit_w=1; fi
        if (( ratio_edit_h < 1 )); then ratio_edit_h=1; fi
        ratio_override="${ratio_edit_w}/${ratio_edit_h}"
        force_redraw=1
      fi
      ;;
    "="|"+")
      cur_scale="$(load_active_setting "$ACTIVE_SIZE_FILE" "1.0")"
      new_scale="$(python3 - <<PY
import math
cur=float("$cur_scale")
print(min(2.0, round(cur + 0.1, 2)))
PY
)"
      save_setting "$ACTIVE_SIZE_FILE" "$new_scale"
      force_redraw=1
      ;;
    "-")
      cur_scale="$(load_active_setting "$ACTIVE_SIZE_FILE" "1.0")"
      new_scale="$(python3 - <<PY
import math
cur=float("$cur_scale")
print(max(0.5, round(cur - 0.1, 2)))
PY
)"
      save_setting "$ACTIVE_SIZE_FILE" "$new_scale"
      force_redraw=1
      ;;
  esac

  if [[ "$mode" == "cal" ]]; then
    case "$k" in
      h)
        if [[ "$view_month" == "01" ]]; then
          view_month="12"
          view_year="$((view_year - 1))"
        else
          view_month="$(printf "%02d" "$((10#$view_month - 1))")"
        fi
        force_redraw=1
        ;;
      l)
        if [[ "$view_month" == "12" ]]; then
          view_month="01"
          view_year="$((view_year + 1))"
        else
          view_month="$(printf "%02d" "$((10#$view_month + 1))")"
        fi
        force_redraw=1
        ;;
      H) view_year="$((view_year - 1))"; force_redraw=1 ;;
      L) view_year="$((view_year + 1))"; force_redraw=1 ;;
      t)
        view_year="$today_year"
        view_month="$today_month"
        force_redraw=1
        ;;
      j)
        printf "\nYYYY-MM> "
        read -r target
        if [[ "$target" =~ ^([0-9]{4})-([0-9]{1,2})$ ]]; then
          new_year="${BASH_REMATCH[1]}"
          new_month="${BASH_REMATCH[2]}"
          if (( new_month >= 1 && new_month <= 12 )); then
            view_year="$new_year"
            view_month="$(printf "%02d" "$new_month")"
            force_redraw=1
          fi
        fi
        ;;
    esac
  fi
  if [[ "$mode" == "gallery" && "$gallery_count" -gt 0 && "$gallery_view" -eq 0 ]]; then
    case "$key" in
      j)
        if (( gallery_index < gallery_count - 1 )); then
          gallery_index=$((gallery_index + 1))
          save_setting "$GALLERY_INDEX_FILE" "$gallery_index"
          force_redraw=1
        fi
        ;;
      k)
        if (( gallery_index > 0 )); then
          gallery_index=$((gallery_index - 1))
          save_setting "$GALLERY_INDEX_FILE" "$gallery_index"
          force_redraw=1
        fi
        ;;
      [1-9])
        idx=$((10#$key - 1))
        if (( idx < gallery_count )); then
          gallery_index="$idx"
          save_setting "$GALLERY_INDEX_FILE" "$gallery_index"
          force_redraw=1
        fi
        ;;
    esac
  fi
  if [[ "$mode" == "gallery" && "$is_enter" -eq 1 ]]; then
    gallery_view=$((1 - gallery_view))
    save_setting "$GALLERY_VIEW_FILE" "$gallery_view"
    force_redraw=1
  fi
  if [[ "$mode" == "media" && "$is_enter" -eq 1 ]]; then
    media_view=$((1 - media_view))
    save_setting "$MEDIA_VIEW_FILE" "$media_view"
    force_redraw=1
  fi
  if [[ "$mode" == "media" && "$media_view" -eq 1 ]]; then
    case "$key" in
      h|left) adjust_offset -2 0; force_redraw=1 ;;
      l|right) adjust_offset 2 0; force_redraw=1 ;;
      k|up) adjust_offset 0 -1; force_redraw=1 ;;
      j|down) adjust_offset 0 1; force_redraw=1 ;;
      0)
        offset_x=0
        offset_y=0
        save_setting "$ACTIVE_OFFSET_X_FILE" "$offset_x"
        save_setting "$ACTIVE_OFFSET_Y_FILE" "$offset_y"
        force_redraw=1
        ;;
    esac
  fi
  if [[ "$mode" == "gallery" && "$gallery_view" -eq 1 ]]; then
    case "$key" in
      h|left) adjust_offset -2 0; force_redraw=1 ;;
      l|right) adjust_offset 2 0; force_redraw=1 ;;
      k|up) adjust_offset 0 -1; force_redraw=1 ;;
      j|down) adjust_offset 0 1; force_redraw=1 ;;
      S)
        set_mode "gallery"
        gallery_view=1
        save_setting "$GALLERY_INDEX_FILE" "$gallery_index"
        save_setting "$GALLERY_VIEW_FILE" "$gallery_view"
        force_redraw=1
        ;;
      0)
        offset_x=0
        offset_y=0
        save_setting "$ACTIVE_OFFSET_X_FILE" "$offset_x"
        save_setting "$ACTIVE_OFFSET_Y_FILE" "$offset_y"
        force_redraw=1
        ;;
    esac
  fi
done
