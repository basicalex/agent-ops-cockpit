#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
home_bin="${HOME}/bin"

strip_path_dir() {
  local dir="$1"
  local new=""
  local part=""
  IFS=':' read -r -a parts <<<"$PATH"
  for part in "${parts[@]}"; do
    if [[ "$part" == "$dir" ]]; then
      continue
    fi
    if [[ -z "$new" ]]; then
      new="$part"
    else
      new="$new:$part"
    fi
  done
  echo "$new"
}

is_wrapper() {
  local candidate="$1"
  local head=""
  if [[ ! -f "$candidate" ]]; then
    return 1
  fi
  head="$(head -n 1 "$candidate" 2>/dev/null || true)"
  if [[ "$head" == "#!/usr/bin/env bash" ]]; then
    if grep -q "aoc-codex" "$candidate" 2>/dev/null; then
      return 0
    fi
  fi
  return 1
}

resolve_codex_bin() {
  if [[ -n "${AOC_CODEX_BIN:-}" ]]; then
    echo "$AOC_CODEX_BIN"
    return
  fi
  local search_path=""
  search_path="$(strip_path_dir "$script_dir")"
  search_path="$(PATH="$search_path" strip_path_dir "$home_bin")"
  local found=""
  local part=""
  local candidate=""
  IFS=':' read -r -a parts <<<"$search_path"
  for part in "${parts[@]}"; do
    [[ -n "$part" ]] || continue
    candidate="$part/codex"
    if [[ -x "$candidate" ]]; then
      if is_wrapper "$candidate"; then
        continue
      fi
      found="$candidate"
      break
    fi
  done
  if [[ -n "$found" ]]; then
    echo "$found"
    return
  fi
  echo "codex"
}

codex_bin="$(resolve_codex_bin)"

if ! command -v tmux >/dev/null 2>&1; then
  echo "aoc-codex: tmux not found; running codex without tmux wrapper." >&2
  exec "$codex_bin" "$@"
fi

conf="${AOC_CODEX_TMUX_CONF:-${XDG_CONFIG_HOME:-$HOME/.config}/aoc/codex-tmux.conf}"
socket="aoc-codex-${ZELLIJ_PANE_ID:-$$}"
session="codex"

if [[ -f "$conf" ]]; then
  exec tmux -L "$socket" -f "$conf" new-session -A -s "$session" "$codex_bin" "$@"
fi

exec tmux -L "$socket" new-session -A -s "$session" "$codex_bin" "$@"
