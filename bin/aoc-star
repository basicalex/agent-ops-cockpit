#!/usr/bin/env bash
set -euo pipefail

state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"

# Discover root_tag from environment or Agent pane name
discover_root_from_pane_names() {
  # Priority 1: Direct environment variable (fastest)
  if [[ -n "${AOC_ROOT_TAG:-}" ]]; then
    root_tag="$AOC_ROOT_TAG"
    AOC_PROJECT_ROOT_FILE="${AOC_PROJECT_ROOT_FILE:-$state_dir/project_root.${root_tag}}"
    AOC_STAR_FILE="${AOC_STAR_FILE:-$state_dir/starred_root.${root_tag}}"
    return 0
  fi

  # Priority 2: Project root file directly set
  if [[ -n "${AOC_PROJECT_ROOT_FILE:-}" && -f "${AOC_PROJECT_ROOT_FILE:-}" ]]; then
    return 0
  fi

  # Priority 3: Scrape Agent pane name from the current tab
  # Format: "Agent [agent-ops-cockpit]" -> agent-ops-cockpit
  local layout_dump root_tag
  layout_dump="$(zellij action dump-layout 2>/dev/null || true)"
  
  # Logic:
  # 1. Find the tab that is focused (focus=true)
  # 2. Inside that tab, look for a pane with name="Agent [...]"
  # This uses a simple regex assuming standard KDL formatting.
  
  root_tag="$(echo "$layout_dump" | awk '
    /tab .*focus=true/ { in_focus=1; next }
    /tab / { in_focus=0 }
    in_focus && /pane .*name="Agent \[.*\]"/ {
      match($0, /name="Agent \[(.*)\]"/, arr)
      print arr[1]
      exit
    }
  ')"
  
  if [[ -n "$root_tag" ]]; then
    AOC_PROJECT_ROOT_FILE="${AOC_PROJECT_ROOT_FILE:-$state_dir/project_root.${root_tag}}"
    AOC_STAR_FILE="${AOC_STAR_FILE:-$state_dir/starred_root.${root_tag}}"
  fi
}

discover_root_from_pane_names

STAR_FILE="${AOC_STAR_FILE:-$state_dir/starred_root}"
mkdir -p "$(dirname "$STAR_FILE")"

new_root="${1:-$PWD}"
if [[ -f "$new_root" ]]; then
  new_root="$(dirname "$new_root")"
fi
new_root="$(realpath "$new_root")"

echo "Star new root and re-anchor panes?"
echo "  $new_root"
read -r -p "[y/N] " ans
[[ "${ans,,}" == "y" ]] || exit 0

echo "$new_root" > "$STAR_FILE"
if [[ -n "${AOC_PROJECT_ROOT_FILE:-}" ]]; then
  echo "$new_root" > "$AOC_PROJECT_ROOT_FILE"
fi

pane_ids="$(zellij list-panes --format json | python3 - <<'PY'
import json,sys
data=json.load(sys.stdin)
print("\n".join(str(p["id"]) for p in data))
PY
)"

for pid in $pane_ids; do
  zellij action write-chars --pane-id "$pid" "cd \"${new_root}\" && clear\n"
done

echo "Starred root set: $new_root"
