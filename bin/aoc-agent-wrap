#!/usr/bin/env bash
set -euo pipefail

agent_id="${1:-}"
agent_bin="${2:-}"
agent_label="${3:-}"
shift 3 || true

# Set title early, before any execs
if [[ -n "$agent_label" ]]; then
  printf "\033]0;Agent [$agent_label]\007"
fi

if [[ -z "$agent_id" || -z "$agent_bin" ]]; then
  echo "Usage: aoc-agent-wrap <id> <bin> [label] [args...]" >&2
  exit 1
fi

if [[ -z "$agent_label" ]]; then
  agent_label="$agent_id"
fi

env_hint="AOC_${agent_id^^}_BIN"

# --- Resolution Logic ---

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
home_bin="${HOME}/bin"

is_wrapper() {
  local candidate="$1"
  local head=""
  if [[ ! -f "$candidate" ]]; then
    return 1
  fi
  head="$(head -n 1 "$candidate" 2>/dev/null || true)"
  if [[ "$head" == "#!/usr/bin/env bash" ]]; then
    # Heuristic: if it mentions "aoc-" or "tmux -L aoc-" it's likely a wrapper
    if grep -E -q "aoc-|tmux -L aoc-" "$candidate" 2>/dev/null; then
      return 0
    fi
  fi
  return 1
}

resolve_bin() {
  local name="$1"
  local env_var="$2"
  
  # Check environment variable first
  local env_val=""
  env_val="$(printenv "$env_var" || true)"
  if [[ -n "$env_val" ]]; then
    echo "$env_val"
    return
  fi

  # Search full PATH
  local part=""
  local candidate=""
  IFS=':' read -r -a parts <<<"$PATH"
  for part in "${parts[@]}"; do
    [[ -n "$part" ]] || continue
    candidate="$part/$name"
    if [[ -x "$candidate" ]]; then
      if is_wrapper "$candidate"; then
        continue
      fi
      echo "$candidate"
      return
    fi
  done

  if [[ "$name" == "opencode" || "$name" == "open-code" ]]; then
    local pnpm_home="${PNPM_HOME:-$HOME/.local/share/pnpm}"
    local pinned_version="${AOC_OC_VERSION:-}"
    local candidates=()
    local base=""
    for base in "$pnpm_home"/global/*/.pnpm; do
      [[ -d "$base" ]] || continue
      if [[ -n "$pinned_version" ]]; then
        for candidate in "$base"/opencode-ai@"$pinned_version"/node_modules/opencode-ai/bin/opencode; do
          [[ -x "$candidate" ]] || continue
          echo "$candidate"
          return
        done
        for candidate in "$base"/opencode@"$pinned_version"/node_modules/opencode/bin/opencode; do
          [[ -x "$candidate" ]] || continue
          echo "$candidate"
          return
        done
      fi
      for candidate in "$base"/opencode-ai@*/node_modules/opencode-ai/bin/opencode; do
        [[ -x "$candidate" ]] || continue
        candidates+=("$candidate")
      done
      for candidate in "$base"/opencode@*/node_modules/opencode/bin/opencode; do
        [[ -x "$candidate" ]] || continue
        candidates+=("$candidate")
      done
    done
    if ((${#candidates[@]} > 0)); then
      printf '%s\n' "${candidates[@]}" | sort -V | tail -n 1
      return
    fi
  fi
  
  echo "$name"
}

real_bin="$(resolve_bin "$agent_bin" "$env_hint")"

resolved_path="$(command -v "$real_bin" 2>/dev/null || true)"
if [[ -n "$resolved_path" ]] && is_wrapper "$resolved_path"; then
  clear
  echo "$agent_label CLI resolves to an AOC wrapper ($resolved_path)."
  echo "Install the real binary and set $env_hint to its path."
  echo
  read -rsn1 -p "Press any key to exit." _ || true
  exit 0
fi

if ! command -v "$real_bin" >/dev/null 2>&1; then
  clear
  echo "$agent_label CLI ('$agent_bin') not found in PATH."
  echo "Set $env_hint to override the binary."
  echo
  read -rsn1 -p "Press any key to exit." _ || true
  exit 0
fi

# --- Context Injection (Handshake) ---

find_aoc_dir() {
  local base=""
  local probe=""
  if [[ -n "${AOC_PROJECT_ROOT:-}" ]]; then
    base="$AOC_PROJECT_ROOT"
  else
    base="$PWD"
  fi

  probe="$base"
  while [[ -n "$probe" && "$probe" != "/" ]]; do
    if [[ -d "$probe/.aoc" ]]; then
      echo "$probe/.aoc"
      return 0
    fi
    probe="$(dirname "$probe")"
  done

  if [[ -d "$script_dir/../.aoc" ]]; then
    echo "$script_dir/../.aoc"
    return 0
  fi

  if [[ -d "$base/.gemini" ]]; then
    echo "$base/.gemini"
    return 0
  fi

  return 1
}

construct_handshake() {
  local aoc_dir=""
  if ! aoc_dir="$(find_aoc_dir)"; then
    return
  fi

  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo "ðŸš€ AOC SYSTEM HANDSHAKE (Agent Orientation)"
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo
  echo "You are running in an Agent Ops Cockpit (AOC) managed environment."
  echo "This terminal history contains your initial project orientation."
  echo
  echo "ðŸ“‚ PROJECT CONTEXT ($aoc_dir/context.md):"
  if [[ -f "$aoc_dir/context.md" ]]; then
    head -n 50 "$aoc_dir/context.md"
    echo "... [see file for full content]"
  elif [[ -f "$aoc_dir/GEMINI.md" ]]; then
    head -n 50 "$aoc_dir/GEMINI.md"
  fi
  echo
  echo "ðŸ§  PROJECT MEMORY ($aoc_dir/memory.md):"
  if [[ -f "$aoc_dir/memory.md" ]]; then
    tail -n 20 "$aoc_dir/memory.md"
  fi
  echo
  echo "ðŸ“‹ ACTIVE TASKS (.taskmaster/):"
  if command -v aoc >/dev/null 2>&1; then
    aoc task list --tag "${AOC_TAG:-master}" 2>/dev/null | head -n 20 || echo "No active tasks."
  elif command -v aoc-cli >/dev/null 2>&1; then
    aoc-cli task list --tag "${AOC_TAG:-master}" 2>/dev/null | head -n 20 || echo "No active tasks."
  elif command -v task-master >/dev/null 2>&1; then
    task-master list --tag "${AOC_TAG:-master}" 2>/dev/null | head -n 20 || echo "No active tasks."
  fi
  echo
  echo "ðŸ’¡ OPERATIONAL DIRECTIVE:"
  echo "1. The file '$aoc_dir/memory.md' is the LIVE source of truth for architectural decisions."
  echo "2. Use 'aoc-mem add \"fact\"' to record new decisions."
  echo "3. Use 'aoc task' (or 'task-master') tools to track your progress."
  echo "4. Read the files explicitly if you need updated context."
  echo
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo "Starting $agent_label CLI..."
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  sleep 1
}

# We'll use a temporary script to handle the handshake and exec to avoid complex quoting in tmux
bootloader="$(mktemp /tmp/aoc-bootloader-XXXXXX.sh)"
chmod +x "$bootloader"
{
  echo "#!/usr/bin/env bash"
  declare -f find_aoc_dir
  echo "construct_handshake() {"
  declare -f construct_handshake | tail -n +2
  echo "}"
  echo "printf \"\\033]0;Agent [$agent_label]\\007\""
  echo "construct_handshake"
  echo "rm -f \"\$0\"" # Self-destruct
  echo "exec \"$real_bin\" \"\$@\""
} > "$bootloader"

if [[ "${AOC_NO_TMUX:-0}" == "1" ]]; then
  exec "$bootloader" "$@"
fi

if ! command -v tmux >/dev/null 2>&1; then
  echo "aoc-$agent_id: tmux not found; running $agent_bin with handshake but no tmux wrapper." >&2
  exec "$bootloader" "$@"
fi

conf="${AOC_AGENT_TMUX_CONF:-${XDG_CONFIG_HOME:-$HOME/.config}/aoc/codex-tmux.conf}"
socket="aoc-${agent_id}-${ZELLIJ_PANE_ID:-$$}"
session="$agent_id"
socket_dir="/tmp/tmux-$(id -u)"
socket_path="$socket_dir/$socket"

# Clean up stale sockets that block tmux from starting.
if [[ -S "$socket_path" ]]; then
  if ! tmux -L "$socket" ls >/dev/null 2>&1; then
    rm -f "$socket_path"
  fi
fi

if [[ -f "$conf" ]]; then
  exec tmux -L "$socket" -f "$conf" new-session -A -s "$session" "$bootloader" "$@"
fi

exec tmux -L "$socket" new-session -A -s "$session" "$bootloader" "$@"
