#!/usr/bin/env bash
set -euo pipefail

source "$(dirname "$0")/aoc-utils.sh"

if [[ "${AOC_SMOKE_TEST:-0}" == "1" ]]; then
  exit 0
fi

agent_id="${1:-}"
agent_bin="${2:-}"
agent_label="${3:-}"
shift 3 || true

# Set title early, before any execs
if [[ -n "$agent_label" ]]; then
  printf "\033]0;Agent [$agent_label]\007"
fi

if [[ -z "$agent_id" || -z "$agent_bin" ]]; then
  echo "Usage: aoc-agent-wrap <id> <bin> [label] [args...]" >&2
  exit 1
fi

if [[ -z "$agent_label" ]]; then
  agent_label="$agent_id"
fi

env_hint="AOC_${agent_id^^}_BIN"

# --- Resolution Logic ---

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
home_bin="${HOME}/bin"
cargo_bin="$HOME/.cargo/bin"

resolve_session_id() {
  if [[ -n "${ZELLIJ_SESSION_NAME:-}" ]]; then
    printf '%s' "$ZELLIJ_SESSION_NAME"
    return
  fi
  if [[ -n "${AOC_SESSION_ID:-}" ]]; then
    printf '%s' "$AOC_SESSION_ID"
    return
  fi
  local candidate=""
  local attempt
  for attempt in 1 2 3 4 5 6 7 8 9 10 11 12; do
    candidate="$(generate_whimsical_session_id)"
    if session_name_exists "$candidate"; then
      continue
    fi
    printf '%s' "$candidate"
    return
  done
  printf 'pid-%s' "$$"
}

resolve_pane_id() {
  if [[ -n "${AOC_PANE_ID:-}" ]]; then
    printf '%s' "$AOC_PANE_ID"
    return
  fi
  if [[ -n "${ZELLIJ_PANE_ID:-}" ]]; then
    printf '%s' "$ZELLIJ_PANE_ID"
    return
  fi
  printf '%s' "$$"
}

resolve_project_root() {
  if [[ -n "${AOC_PROJECT_ROOT:-}" ]]; then
    printf '%s' "$AOC_PROJECT_ROOT"
    return
  fi
  printf '%s' "$PWD"
}

wrap_rs_cmd=()
resolve_wrap_rs_cmd() {
  wrap_rs_cmd=()
  if [[ -n "${AOC_AGENT_WRAP_RS_BIN:-}" ]]; then
    wrap_rs_cmd=("$AOC_AGENT_WRAP_RS_BIN")
    return
  fi
  local local_release="$script_dir/../crates/target/release/aoc-agent-wrap-rs"
  local local_debug="$script_dir/../crates/target/debug/aoc-agent-wrap-rs"
  if [[ -x "$local_release" ]]; then
    wrap_rs_cmd=("$local_release")
    return
  fi
  if [[ -x "$local_debug" ]]; then
    wrap_rs_cmd=("$local_debug")
    return
  fi
  if command -v aoc-agent-wrap-rs >/dev/null 2>&1; then
    wrap_rs_cmd=(aoc-agent-wrap-rs)
    return
  fi
  if [[ -x "$home_bin/aoc-agent-wrap-rs" ]]; then
    wrap_rs_cmd=("$home_bin/aoc-agent-wrap-rs")
    return
  fi
  if [[ -x "$cargo_bin/aoc-agent-wrap-rs" ]]; then
    wrap_rs_cmd=("$cargo_bin/aoc-agent-wrap-rs")
    return
  fi
  local manifest_path=""
  if [[ -n "${AOC_PROJECT_ROOT:-}" && -f "${AOC_PROJECT_ROOT}/crates/Cargo.toml" ]]; then
    manifest_path="${AOC_PROJECT_ROOT}/crates/Cargo.toml"
  elif [[ -f "$script_dir/../crates/Cargo.toml" ]]; then
    manifest_path="$script_dir/../crates/Cargo.toml"
  fi
  if command -v cargo >/dev/null 2>&1 && [[ -n "$manifest_path" ]]; then
    wrap_rs_cmd=(cargo run --manifest-path "$manifest_path" -p aoc-agent-wrap-rs --)
  fi
}

is_wrapper() {
  local candidate="$1"
  if [[ ! -f "$candidate" ]]; then
    return 1
  fi
  if LC_ALL=C head -n 1 "$candidate" 2>/dev/null | grep -Fxq "#!/usr/bin/env bash"; then
    # Heuristic: if it mentions "aoc-" or "tmux -L aoc-" it's likely a wrapper
    if grep -E -q "aoc-|tmux -L aoc-" "$candidate" 2>/dev/null; then
      return 0
    fi
  fi
  return 1
}

resolve_bin() {
  local name="$1"
  local env_var="$2"
  
  # Check environment variable first
  local env_val=""
  env_val="$(printenv "$env_var" || true)"
  if [[ -n "$env_val" ]]; then
    echo "$env_val"
    return
  fi

  # Search full PATH
  local part=""
  local candidate=""
  IFS=':' read -r -a parts <<<"$PATH"
  for part in "${parts[@]}"; do
    [[ -n "$part" ]] || continue
    candidate="$part/$name"
    if [[ -x "$candidate" ]]; then
      if is_wrapper "$candidate"; then
        continue
      fi
      echo "$candidate"
      return
    fi
  done

  if [[ "$name" == "opencode" || "$name" == "open-code" ]]; then
    local pnpm_home="${PNPM_HOME:-$HOME/.local/share/pnpm}"
    local pinned_version="${AOC_OC_VERSION:-}"
    local candidates=()
    local base=""
    for base in "$pnpm_home"/global/*/.pnpm; do
      [[ -d "$base" ]] || continue
      if [[ -n "$pinned_version" ]]; then
        for candidate in "$base"/opencode-ai@"$pinned_version"/node_modules/opencode-ai/bin/opencode; do
          [[ -x "$candidate" ]] || continue
          echo "$candidate"
          return
        done
        for candidate in "$base"/opencode@"$pinned_version"/node_modules/opencode/bin/opencode; do
          [[ -x "$candidate" ]] || continue
          echo "$candidate"
          return
        done
      fi
      for candidate in "$base"/opencode-ai@*/node_modules/opencode-ai/bin/opencode; do
        [[ -x "$candidate" ]] || continue
        candidates+=("$candidate")
      done
      for candidate in "$base"/opencode@*/node_modules/opencode/bin/opencode; do
        [[ -x "$candidate" ]] || continue
        candidates+=("$candidate")
      done
    done
    if ((${#candidates[@]} > 0)); then
      printf '%s\n' "${candidates[@]}" | sort -V | tail -n 1
      return
    fi
  fi
  
  echo "$name"
}

real_bin="$(resolve_bin "$agent_bin" "$env_hint")"

resolved_path="$(command -v "$real_bin" 2>/dev/null || true)"
if [[ -n "$resolved_path" ]] && is_wrapper "$resolved_path"; then
  clear
  echo "$agent_label CLI resolves to an AOC wrapper ($resolved_path)."
  echo "Install the real binary and set $env_hint to its path."
  echo
  read -rsn1 -p "Press any key to exit." _ || true
  exit 0
fi

if ! command -v "$real_bin" >/dev/null 2>&1; then
  clear
  echo "$agent_label CLI ('$agent_bin') not found in PATH."
  echo "Set $env_hint to override the binary."
  echo
  read -rsn1 -p "Press any key to exit." _ || true
  exit 0
fi

session_id="$(resolve_session_id)"
pane_id="$(resolve_pane_id)"
project_root="$(resolve_project_root)"
hub_addr="$(resolve_hub_addr "$session_id")"
hub_url="$(resolve_hub_url "$hub_addr")"

export AOC_SESSION_ID="$session_id"
export AOC_PANE_ID="$pane_id"
export AOC_PROJECT_ROOT="$project_root"
export AOC_HUB_ADDR="$hub_addr"
export AOC_HUB_URL="$hub_url"
export AOC_AGENT_LABEL="$agent_label"
if [[ -z "${AOC_TAB_SCOPE:-}" ]]; then
  if [[ -n "${AOC_TAB_NAME:-}" ]]; then
    export AOC_TAB_SCOPE="$AOC_TAB_NAME"
  elif [[ -n "${ZELLIJ_TAB_NAME:-}" ]]; then
    export AOC_TAB_SCOPE="$ZELLIJ_TAB_NAME"
  fi
fi
if [[ -z "${AOC_AGENT_PTY:-}" ]]; then
  export AOC_AGENT_PTY=0
fi
if [[ -z "${AOC_AGENT_ID:-}" ]]; then
  export AOC_AGENT_ID="$agent_id"
fi

sanitize_component() {
  local input="$1"
  local output
  output="$(printf '%s' "$input" | sed -E 's/[^A-Za-z0-9._-]+/_/g')"
  printf '%s' "${output:-unknown}"
}

state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"
lease_session="$(sanitize_component "${AOC_SESSION_ID:-unknown}")"
lease_pane="$(sanitize_component "${AOC_PANE_ID:-${ZELLIJ_PANE_ID:-unknown}}")"
lease_dir="$state_dir/pane-leases/$lease_session"
lease_file="$lease_dir/${lease_pane}.lease"
instance_seed="$(date +%s 2>/dev/null || printf '%s' "$$")"
pane_instance_id="${AOC_PANE_INSTANCE_ID:-${AOC_SESSION_ID:-pid}-${AOC_PANE_ID:-${ZELLIJ_PANE_ID:-$$}}-$$-${RANDOM}-${instance_seed}}"
mkdir -p "$lease_dir" 2>/dev/null || true
printf '%s\n' "$pane_instance_id" >"$lease_file" 2>/dev/null || true
export AOC_PANE_INSTANCE_ID="$pane_instance_id"
export AOC_PANE_LEASE_FILE="$lease_file"

setup_rtk_routing() {
  is_truthy() {
    local value="${1:-}"
    value="$(printf '%s' "$value" | tr '[:upper:]' '[:lower:]')"
    case "$value" in
      1|true|yes|on) return 0 ;;
      *) return 1 ;;
    esac
  }

  if is_truthy "${AOC_RTK_BYPASS:-0}" || [[ "${AOC_RTK_MODE:-}" == "off" ]]; then
    export AOC_RTK_ACTIVE=0
    return
  fi

  local rtk_ctl="$script_dir/aoc-rtk"
  if [[ ! -x "$rtk_ctl" ]]; then
    rtk_ctl="$(command -v aoc-rtk 2>/dev/null || true)"
  fi

  local rtk_proxy="$script_dir/aoc-rtk-proxy"
  if [[ ! -x "$rtk_proxy" ]]; then
    rtk_proxy="$(command -v aoc-rtk-proxy 2>/dev/null || true)"
  fi

  if [[ -z "$rtk_ctl" || -z "$rtk_proxy" ]]; then
    export AOC_RTK_ACTIVE=0
    return
  fi

  local status_shell=""
  status_shell="$($rtk_ctl status --shell 2>/dev/null || true)"
  if [[ -z "$status_shell" ]]; then
    export AOC_RTK_ACTIVE=0
    return
  fi

  local mode="off"
  local fail_open="1"
  local gain_mode="double-dash"
  local binary="rtk"
  local allowlist=()
  local denylist=()
  local line=""
  local key=""
  local value=""

  while IFS= read -r line; do
    [[ -n "$line" ]] || continue
    key="${line%%=*}"
    value="${line#*=}"
    case "$key" in
      mode) mode="$value" ;;
      fail_open) fail_open="$value" ;;
      gain_mode) gain_mode="$value" ;;
      binary) binary="$value" ;;
      allow) allowlist+=("$value") ;;
      deny) denylist+=("$value") ;;
      *) ;;
    esac
  done <<< "$status_shell"

  if [[ "$mode" != "on" || ${#allowlist[@]} -eq 0 ]]; then
    export AOC_RTK_ACTIVE=0
    return
  fi

  local shim_root="${XDG_STATE_HOME:-$HOME/.local/state}/aoc/rtk-shims"
  local shim_dir="$shim_root/$(sanitize_component "${AOC_SESSION_ID:-unknown}")/$(sanitize_component "${AOC_PANE_ID:-unknown}")"
  mkdir -p "$shim_dir"
  rm -f "$shim_dir"/* 2>/dev/null || true

  local created=0
  local allow_pattern=""
  local cmd_name=""
  local seen=" "

  for allow_pattern in "${allowlist[@]}"; do
    cmd_name="${allow_pattern%% *}"
    if [[ ! "$cmd_name" =~ ^[A-Za-z0-9._+-]+$ ]]; then
      continue
    fi
    if [[ "$seen" == *" $cmd_name "* ]]; then
      continue
    fi
    seen="$seen$cmd_name "
    printf '#!/usr/bin/env bash\nexec "%s" "%s" "$@"\n' "$rtk_proxy" "$cmd_name" > "$shim_dir/$cmd_name"
    chmod +x "$shim_dir/$cmd_name"
    created=1
  done

  if [[ "$created" != "1" ]]; then
    export AOC_RTK_ACTIVE=0
    return
  fi

  export AOC_RTK_ACTIVE=1
  export AOC_RTK_SHIM_DIR="$shim_dir"
  export AOC_RTK_MODE="$mode"
  export AOC_RTK_FAIL_OPEN="$fail_open"
  export AOC_RTK_GAIN_MODE="$gain_mode"
  export AOC_RTK_BINARY="$binary"
  export AOC_RTK_ALLOWLIST="$(printf '%s\n' "${allowlist[@]}")"
  export AOC_RTK_DENYLIST="$(printf '%s\n' "${denylist[@]}")"
  export PATH="$shim_dir:$PATH"
}

setup_rtk_routing

# --- Context Injection (Handshake) ---

find_aoc_dir() {
  local base=""
  local probe=""
  if [[ -n "${AOC_PROJECT_ROOT:-}" && -d "${AOC_PROJECT_ROOT}/.aoc" ]]; then
    echo "${AOC_PROJECT_ROOT}/.aoc"
    return 0
  fi
  base="$PWD"
  # Prefer aoc-align only when it matches the current pane's path.
  if command -v aoc-align >/dev/null 2>&1; then
    local aligned=""
    aligned="$(aoc-align --print-root 2>/dev/null || true)"
    if [[ -n "$aligned" ]]; then
      case "$base" in
        "$aligned"|"$aligned"/*) base="$aligned" ;;
      esac
    fi
  fi

  probe="$base"
  while [[ -n "$probe" && "$probe" != "/" ]]; do
    if [[ -d "$probe/.aoc" ]]; then
      echo "$probe/.aoc"
      return 0
    fi
    probe="$(dirname "$probe")"
  done

  if [[ -d "$script_dir/../.aoc" ]]; then
    echo "$script_dir/../.aoc"
    return 0
  fi

  if [[ -d "$base/.gemini" ]]; then
    echo "$base/.gemini"
    return 0
  fi

  return 1
}

construct_handshake() {
  local aoc_dir=""
  local stm_latest=""
  local stm_current=""
  local stm_current_has_content=0
  if ! aoc_dir="$(find_aoc_dir)"; then
    return
  fi

  stm_current="$aoc_dir/stm/current.md"
  if [[ -d "$aoc_dir/stm/archive" ]]; then
    stm_latest="$(ls -1t "$aoc_dir/stm/archive"/*.md 2>/dev/null | head -n 1 || true)"
  fi
  if [[ -f "$stm_current" ]] && grep -q '[^[:space:]]' "$stm_current"; then
    stm_current_has_content=1
  fi

  local handshake_mode="${AOC_HANDSHAKE_MODE:-}"
  if [[ -z "$handshake_mode" ]]; then
    if [[ "${AOC_AGENT_ID:-}" == "pi" || "${AOC_AGENT_ID:-}" == "pi-r" ]]; then
      handshake_mode="${AOC_PI_HANDSHAKE_MODE:-compact}"
    else
      handshake_mode="full"
    fi
  fi
  handshake_mode="$(printf '%s' "$handshake_mode" | tr '[:upper:]' '[:lower:]')"
  case "$handshake_mode" in
    full|compact|off) ;;
    *) handshake_mode="full" ;;
  esac

  if [[ "$handshake_mode" == "off" ]]; then
    return
  fi

  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo "ðŸš€ AOC SYSTEM HANDSHAKE (Agent Orientation)"
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo
  echo "You are running in an Agent Ops Cockpit (AOC) managed environment."
  echo "This terminal history contains your initial project orientation."

  if [[ "$handshake_mode" == "compact" ]]; then
    echo
    echo "ðŸ“‚ PROJECT ROOT: ${AOC_PROJECT_ROOT:-$PWD}"
    echo "Context map: $aoc_dir/context.md (open on demand)"
    echo "Memory log: $aoc_dir/memory.md (use: aoc-mem read)"
    echo "Tasks: use tm list / aoc-task list on demand"

    echo
    echo "ðŸ§ª RTK ROUTING:"
    if [[ "${AOC_RTK_ACTIVE:-0}" == "1" ]]; then
      echo "Active (mode=${AOC_RTK_MODE:-on}, fail-open=${AOC_RTK_FAIL_OPEN:-1})."
    elif is_truthy "${AOC_RTK_BYPASS:-0}" || [[ "${AOC_RTK_MODE:-}" == "off" ]]; then
      echo "Bypassed (AOC_RTK_BYPASS=1 or AOC_RTK_MODE=off)."
    else
      echo "Inactive (run: aoc-rtk status)"
    fi

    echo
    echo "âš¡ STM DIARY:"
    if [[ -n "$stm_latest" ]]; then
      echo "Latest archive: $stm_latest"
    else
      echo "Latest archive: none"
    fi
    if [[ "$stm_current_has_content" == "1" ]]; then
      echo "Current draft has unarchived notes: $stm_current"
    fi
    echo "Resume command: aoc-stm handoff"

    echo
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "Starting ${AOC_AGENT_LABEL:-$agent_label} CLI..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    return
  fi
  echo
  echo "ðŸ“‚ PROJECT CONTEXT ($aoc_dir/context.md):"
  if [[ -f "$aoc_dir/context.md" ]]; then
    cat "$aoc_dir/context.md"
  elif [[ -f "$aoc_dir/GEMINI.md" ]]; then
    cat "$aoc_dir/GEMINI.md"
  fi
  echo
  echo "ðŸ§  PROJECT MEMORY ($aoc_dir/memory.md):"
  if [[ -f "$aoc_dir/memory.md" ]]; then
    tail -n 20 "$aoc_dir/memory.md"
  fi
  echo
  echo "ðŸ“‹ ACTIVE TASKS (.taskmaster/):"
  if command -v tm >/dev/null 2>&1; then
    tm list --tag "${AOC_TAG:-master}" 2>/dev/null | head -n 20 || echo "No active tasks."
  elif command -v aoc-task >/dev/null 2>&1; then
    aoc-task list --tag "${AOC_TAG:-master}" 2>/dev/null | head -n 20 || echo "No active tasks."
  elif command -v aoc-cli >/dev/null 2>&1; then
    aoc-cli task list --tag "${AOC_TAG:-master}" 2>/dev/null | head -n 20 || echo "No active tasks."
  elif command -v task-master >/dev/null 2>&1; then
    task-master list --tag "${AOC_TAG:-master}" 2>/dev/null | head -n 20 || echo "No active tasks."
  fi

  echo
  echo "ðŸ§ª RTK ROUTING:"
  if [[ "${AOC_RTK_ACTIVE:-0}" == "1" ]]; then
    echo "Active (mode=${AOC_RTK_MODE:-on}, fail-open=${AOC_RTK_FAIL_OPEN:-1})."
  elif is_truthy "${AOC_RTK_BYPASS:-0}" || [[ "${AOC_RTK_MODE:-}" == "off" ]]; then
    echo "Bypassed (AOC_RTK_BYPASS=1 or AOC_RTK_MODE=off)."
  else
    echo "Inactive (run: aoc-rtk status)"
  fi

  echo
  if [[ -n "$stm_latest" || "$stm_current_has_content" == "1" ]]; then
    echo "âš¡ STM DIARY AVAILABLE:"
    if [[ -n "$stm_latest" ]]; then
      echo "Latest archive: $stm_latest"
    else
      echo "Latest archive: none"
    fi
    if [[ "$stm_current_has_content" == "1" ]]; then
      echo "Current draft: $stm_current (has unarchived notes)"
    fi
    echo "Do not auto-read STM unless the user asks for it (eg: starts with 'stm ...')."
    echo "If not requested, mention STM availability at the end of your first response."
    echo "If the user asks to continue/resume/handoff, run: aoc-stm handoff (current first, archive fallback)."
    echo "To load current STM draft explicitly, run: aoc-stm (or aoc-stm read-current)."
    echo "To read the latest archived snapshot, run: aoc-stm read (or aoc-stm-read)."
  else
    echo "âš¡ STM DIARY AVAILABLE: none"
  fi

  echo
  echo "ðŸ’¡ OPERATIONAL DIRECTIVE:"
  echo "1. The file '$aoc_dir/memory.md' is the LIVE source of truth for architectural decisions."
  echo "2. Use 'aoc-mem add \"fact\"' to record new decisions."
  echo "3. Use 'tm' (alias for 'aoc-task') to track your progress."
  echo "4. If a task has a PRD link, read it before implementation (aoc-task prd show <task-id>)."
  echo "5. PRD links are task-level only; subtasks must not define PRD links."
  echo "6. Use aoc-stm add/edit/archive to maintain STM diary entries; run aoc-stm for current draft and aoc-stm read for archived snapshots."
  echo
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo "Starting ${AOC_AGENT_LABEL:-$agent_label} CLI..."
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
}

# We'll use a temporary script to handle the handshake and exec to avoid complex quoting in tmux
bootloader="$(mktemp /tmp/aoc-bootloader-XXXXXX.sh)"
chmod +x "$bootloader"
{
  echo "#!/usr/bin/env bash"
  declare -f find_aoc_dir
  echo "construct_handshake() {"
  declare -f construct_handshake | tail -n +2
  echo "}"
  echo "printf \"\\033]0;Agent [$agent_label]\\007\""
  echo "construct_handshake"
  echo "rm -f \"\$0\"" # Self-destruct
  echo "exec \"$real_bin\" \"\$@\""
} > "$bootloader"

resolve_wrap_rs_cmd
wrapped_cmd=()
if ((${#wrap_rs_cmd[@]} > 0)); then
  wrap_rs_help=""
  wrap_rs_supports_hub_addr=0
  wrap_rs_supports_tab_scope=0
  if [[ -n "${AOC_TAB_SCOPE:-}" || -n "${AOC_HUB_ADDR:-}" ]]; then
    wrap_rs_help="$("${wrap_rs_cmd[@]}" --help 2>/dev/null || true)"
    if [[ "$wrap_rs_help" == *"--hub-addr"* ]]; then
      wrap_rs_supports_hub_addr=1
    fi
    if [[ "$wrap_rs_help" == *"--tab-scope"* ]]; then
      wrap_rs_supports_tab_scope=1
    fi
  fi
  wrapped_cmd=(
    "${wrap_rs_cmd[@]}"
    --session "$AOC_SESSION_ID"
    --pane-id "$AOC_PANE_ID"
    --agent-id "$AOC_AGENT_LABEL"
    --project-root "$AOC_PROJECT_ROOT"
  )
  if [[ "$wrap_rs_supports_tab_scope" == "1" && -n "${AOC_TAB_SCOPE:-}" ]]; then
    wrapped_cmd+=(--tab-scope "${AOC_TAB_SCOPE:-}")
  fi
  if [[ "$wrap_rs_supports_hub_addr" == "1" ]]; then
    wrapped_cmd+=(--hub-addr "$AOC_HUB_ADDR")
  fi
  wrapped_cmd+=(
    --
    "$bootloader"
    "$@"
  )
else
  wrapped_cmd=("$bootloader" "$@")
fi

agent_runtime_id="${AOC_AGENT_ID:-$agent_id}"
is_omo_agent=0
if [[ "$agent_runtime_id" == "omo" ]]; then
  is_omo_agent=1
fi
is_pi_family_agent=0
if [[ "$agent_runtime_id" == "pi" || "$agent_runtime_id" == "pi-r" ]]; then
  is_pi_family_agent=1
fi

stderr_capture_enabled="${AOC_AGENT_CAPTURE_STDERR:-0}"
if [[ "$is_omo_agent" == "1" ]]; then
  stderr_capture_enabled="${AOC_OMO_CAPTURE_STDERR:-1}"
elif [[ "$is_pi_family_agent" == "1" ]]; then
  stderr_capture_enabled="${AOC_PI_CAPTURE_STDERR:-1}"
fi
stderr_log_file=""
if [[ "$stderr_capture_enabled" == "1" ]]; then
  stderr_log_dir="${AOC_AGENT_STDERR_LOG_DIR:-$state_dir/stderr}"
  mkdir -p "$stderr_log_dir" 2>/dev/null || true
  stderr_log_file="$stderr_log_dir/$(sanitize_component "$AOC_SESSION_ID")-$(sanitize_component "$AOC_PANE_ID")-$(sanitize_component "$agent_runtime_id").log"
fi

run_wrapped_cmd() {
  if [[ -n "$stderr_log_file" ]]; then
    "$@" 2> >(tee -a "$stderr_log_file" >&2)
    return $?
  fi
  "$@"
}

run_wrapped_exec() {
  if [[ -n "$stderr_log_file" ]]; then
    set +e
    run_wrapped_cmd "$@"
    local status=$?
    set -e
    exit "$status"
  fi
  exec "$@"
}

tmux_allowlist=",${AOC_TMUX_AGENT_ALLOWLIST:-codex,pi,pi-r},"
tmux_allowlist="${tmux_allowlist//[[:space:]]/}"

if [[ "$tmux_allowlist" != *",$agent_id,"* ]]; then
  run_wrapped_exec "${wrapped_cmd[@]}"
fi

if [[ "${AOC_NO_TMUX:-0}" == "1" ]]; then
  run_wrapped_exec "${wrapped_cmd[@]}"
fi

if ! command -v tmux >/dev/null 2>&1; then
  echo "aoc-$agent_id: tmux not found; running $agent_bin with handshake but no tmux wrapper." >&2
  run_wrapped_exec "${wrapped_cmd[@]}"
fi

conf="${AOC_AGENT_TMUX_CONF:-${XDG_CONFIG_HOME:-$HOME/.config}/aoc/codex-tmux.conf}"
socket="aoc-${agent_id}-${ZELLIJ_PANE_ID:-$$}"
session="$agent_id"
socket_dir="/tmp/tmux-$(id -u)"
socket_path="$socket_dir/$socket"

# Clean up stale sockets that block tmux from starting.
if [[ -S "$socket_path" ]]; then
  if ! tmux -L "$socket" ls >/dev/null 2>&1; then
    rm -f "$socket_path"
  fi
fi

if [[ -f "$conf" ]]; then
  tmux_cmd=(tmux -L "$socket" -f "$conf" new-session -A -s "$session" "${wrapped_cmd[@]}")
else
  tmux_cmd=(tmux -L "$socket" new-session -A -s "$session" "${wrapped_cmd[@]}")
fi

run_wrapped_exec "${tmux_cmd[@]}"
