#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: aoc-agent-install <status|install|update> <agent>

Agents: pi

Examples:
  aoc-agent-install status pi
  aoc-agent-install install pi
EOF
}

normalize_agent() {
  local normalized
  normalized="$(printf '%s' "$1" | tr '[:upper:]' '[:lower:]')"
  case "$normalized" in
    pi|pi-agent|pi_agent)
      printf '%s\n' "pi"
      ;;
    *)
      return 1
      ;;
  esac
}

agent_label() {
  printf '%s\n' "PI Agent (npm)"
}

have() {
  command -v "$1" >/dev/null 2>&1
}

status_agent() {
  local bin_name="${AOC_PI_BIN:-pi}"
  if have "$bin_name"; then
    printf '%s\n' "installed"
  else
    printf '%s\n' "missing"
  fi
}

default_install_cmd() {
  printf '%s\n' "if command -v pnpm >/dev/null 2>&1; then pnpm add -g @mariozechner/pi-coding-agent; elif command -v npm >/dev/null 2>&1; then npm install -g --prefix \"${AOC_NPM_GLOBAL_PREFIX:-$HOME/.local}\" @mariozechner/pi-coding-agent; elif command -v corepack >/dev/null 2>&1; then corepack enable && corepack prepare pnpm@latest --activate && pnpm add -g @mariozechner/pi-coding-agent; else echo 'pnpm/npm/corepack not found' >&2; exit 1; fi"
}

default_update_cmd() {
  printf '%s\n' "if command -v pnpm >/dev/null 2>&1; then pnpm add -g @mariozechner/pi-coding-agent@latest; elif command -v npm >/dev/null 2>&1; then npm install -g --prefix \"${AOC_NPM_GLOBAL_PREFIX:-$HOME/.local}\" @mariozechner/pi-coding-agent@latest; elif command -v corepack >/dev/null 2>&1; then corepack enable && corepack prepare pnpm@latest --activate && pnpm add -g @mariozechner/pi-coding-agent@latest; else echo 'pnpm/npm/corepack not found' >&2; exit 1; fi"
}

action_var_hint() {
  local action="$1"
  if [[ "$action" == "install" ]]; then
    printf '%s\n' "AOC_PI_INSTALL_CMD"
  else
    printf '%s\n' "AOC_PI_UPDATE_CMD"
  fi
}

resolve_action_cmd() {
  local action="$1"
  if [[ "$action" == "install" ]]; then
    printf '%s\n' "${AOC_PI_INSTALL_CMD:-$(default_install_cmd)}"
  else
    printf '%s\n' "${AOC_PI_UPDATE_CMD:-${AOC_PI_INSTALL_CMD:-$(default_update_cmd)}}"
  fi
}

run_action() {
  local action="$1"
  local cmd=""
  local label=""
  local verb=""
  local output=""

  label="$(agent_label)"
  cmd="$(resolve_action_cmd "$action")"

  if [[ -z "${cmd// }" ]]; then
    echo "No $action command configured for $label. Set $(action_var_hint "$action")." >&2
    return 1
  fi

  if output="$(bash -lc "$cmd" 2>&1)"; then
    if [[ "$action" == "install" ]]; then
      verb="Installed"
    else
      verb="Updated"
    fi
    printf '%s\n' "$verb $label"
    if [[ -n "$output" ]]; then
      printf '%s\n' "$output"
    fi
    return 0
  fi

  if [[ -n "$output" ]]; then
    printf '%s\n' "$output" >&2
  else
    echo "$action failed for $label" >&2
  fi
  return 1
}

if [[ $# -lt 2 ]]; then
  usage
  exit 1
fi

action="$1"
agent_raw="$2"

agent="$(normalize_agent "$agent_raw" 2>/dev/null || true)"
if [[ -z "$agent" ]]; then
  echo "Unsupported agent: $agent_raw" >&2
  usage
  exit 1
fi

case "$action" in
  status)
    status_agent
    ;;
  install|update)
    run_action "$action"
    ;;
  -h|--help|help)
    usage
    ;;
  *)
    echo "Unsupported action: $action" >&2
    usage
    exit 1
    ;;
esac
