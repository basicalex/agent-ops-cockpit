#!/usr/bin/env bash
set -euo pipefail

agent_id="pi-r"
agent_bin="${AOC_PIR_BIN:-pi-r}"
agent_label="PI Agent (Rust)"

if [[ "${AOC_AGENT_RUN:-0}" == "1" ]]; then
  project_root="${AOC_PROJECT_ROOT:-$PWD}"
  context_profile="${AOC_PI_CONTEXT_PROFILE:-default}"
  context_lean_mode="${AOC_PI_CONTEXT_LEAN_MODE:-1}"
  context_lean_prompt="${AOC_PI_CONTEXT_LEAN_PROMPT:-$project_root/.aoc/prompts/pi-context-lean.md}"
  has_prompt_override="0"
  extra_args=()

  for arg in "$@"; do
    case "$arg" in
      --system-prompt|--system-prompt=*|--append-system-prompt|--append-system-prompt=*)
        has_prompt_override="1"
        ;;
    esac
  done

  if [[ "$has_prompt_override" == "0" ]]; then
    if [[ "$context_profile" == "lean" && "$context_lean_mode" != "0" && -f "$context_lean_prompt" ]]; then
      extra_args+=(--append-system-prompt "$context_lean_prompt")
    fi
  fi

  if [[ -n "${AOC_PI_APPEND_SYSTEM_PROMPT:-}" ]]; then
    extra_args+=(--append-system-prompt "${AOC_PI_APPEND_SYSTEM_PROMPT}")
  fi

  if [[ -z "${AOC_RTK_ULTRA_COMPACT:-}" ]]; then
    export AOC_RTK_ULTRA_COMPACT=1
  fi
  if [[ -z "${AOC_RTK_ROUTE_NON_TTY_STDIN:-}" ]]; then
    export AOC_RTK_ROUTE_NON_TTY_STDIN=1
  fi

  if [[ -z "${AOC_HANDSHAKE_MODE:-}" ]]; then
    export AOC_HANDSHAKE_MODE="${AOC_PI_HANDSHAKE_MODE:-compact}"
  fi

  exec aoc-agent-wrap "$agent_id" "$agent_bin" "$agent_label" "${extra_args[@]}" "$@"
fi

if [[ -n "${ZELLIJ:-}" || -n "${ZELLIJ_SESSION_NAME:-}" ]]; then
  AOC_LAUNCH_AGENT_ID="$agent_id" aoc-new-tab --aoc --name "$agent_label" "$@"
else
  AOC_LAUNCH_AGENT_ID="$agent_id" aoc-launch
fi
