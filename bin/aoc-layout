#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: aoc-layout [--set [layout]] [--tab [layout]] [--current]

Interactive dashboard for selecting the default layout or launching tabs.
Layouts are discovered from project `.aoc/layouts/` and global `~/.config/zellij/layouts/`.
EOF
}

state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"
default_file="${state_dir}/layout_default"

mkdir -p "$state_dir"

list_layouts() {
  # List .kdl files from project and global layout directories.
  # Project layouts are checked first so shared repo layouts are visible.
  local project_root=""
  local project_layout_dir=""
  project_root="$(resolve_project_root || true)"
  if [[ -n "$project_root" ]]; then
    project_layout_dir="$project_root/.aoc/layouts"
  fi

  {
    echo "aoc"
    if [[ -n "$project_layout_dir" ]]; then
      find "$project_layout_dir" -maxdepth 1 -name "*.kdl" -printf "%f\n" 2>/dev/null | sed 's/\.kdl$//'
    fi
    find "$HOME/.config/zellij/layouts" -maxdepth 1 -name "*.kdl" -printf "%f\n" 2>/dev/null | sed 's/\.kdl$//'
  } | awk 'NF && !seen[$0]++'
}

resolve_project_root() {
  local probe="${AOC_PROJECT_ROOT:-${ZELLIJ_PROJECT_ROOT:-$PWD}}"
  if [[ ! -d "$probe" ]]; then
    probe="$PWD"
  fi
  probe="$(cd "$probe" >/dev/null 2>&1 && pwd -P || pwd -P)"

  while :; do
    if [[ -d "$probe/.aoc" ]]; then
      printf '%s' "$probe"
      return 0
    fi
    if [[ "$probe" == "/" ]]; then
      break
    fi
    probe="$(dirname "$probe")"
  done

  return 1
}

pick_layout() {
  local choice=""
  if command -v fzf >/dev/null 2>&1; then
    choice="$(list_layouts | fzf --prompt="Layout > " || true)"
    printf "%s" "$choice"
    return 0
  fi

  echo "Select layout:"
  local i=1
  local layouts=()
  while IFS= read -r line; do
    layouts+=("$line")
    echo "  $i) $line"
    ((i++))
  done < <(list_layouts)

  read -r -p "Layout number > " choice
  if [[ "$choice" =~ ^[0-9]+$ ]] && ((choice >= 1 && choice <= ${#layouts[@]})); then
    printf "%s" "${layouts[$((choice-1))]}"
  fi
}

current_layout() {
  if [[ -f "$default_file" ]]; then
    cat "$default_file" 2>/dev/null || true
  else
    echo "aoc"
  fi
}

set_default() {
  local layout="$1"
  if [[ -z "$layout" ]]; then
    layout="$(pick_layout)"
  fi
  if [[ -z "$layout" ]]; then
    echo "No layout selected." >&2
    exit 1
  fi
  echo "$layout" >"$default_file"
  echo "Default layout set to '$layout'."
}

open_tab() {
  local layout="$1"
  if [[ -z "$layout" ]]; then
    layout="$(pick_layout)"
  fi
  if [[ -z "$layout" ]]; then
    echo "No layout selected." >&2
    exit 1
  fi
  
  if [[ -n "${ZELLIJ:-}" || -n "${ZELLIJ_SESSION_NAME:-}" ]]; then
    aoc-new-tab --layout "$layout"
  else
    # If not in Zellij, launch new session with this layout
    AOC_LAYOUT="$layout" aoc-launch
  fi
}

case "${1:-}" in
  --set)
    shift
    set_default "${1:-}"
    exit 0
    ;;
  --tab)
    shift
    open_tab "${1:-}"
    exit 0
    ;;
  --current)
    current_layout
    exit 0
    ;;
  -h|--help)
    usage
    exit 0
    ;;
  "")
    :
    ;;
  *)
    echo "Unknown option: $1" >&2
    usage
    exit 1
    ;;
esac

if ! command -v fzf >/dev/null 2>&1; then
  usage
  exit 1
fi

action="$(printf "%s\n" \
  "Set default layout" \
  "Open new tab" \
  "Show current" \
  | fzf --prompt="AOC Layout > " --height=40% --border || true)"

case "$action" in
  "Set default layout") set_default "" ;;
  "Open new tab") open_tab "" ;;
  "Show current")
    current="$(current_layout)"
    if [[ -z "$current" ]]; then
      echo "No default layout set."
    else
      echo "Default layout: $current"
    fi
    ;;
  *) exit 0 ;;
esac
