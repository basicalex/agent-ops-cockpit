#!/usr/bin/env bash
set -euo pipefail

layout=""
local_layout="$HOME/.config/zellij/layouts/aoc.local.kdl"
aoc_config="$HOME/.config/zellij/aoc.config.kdl"
state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"
default_layout_file="${state_dir}/layout_default"

if [[ "${AOC_CLEANUP:-1}" != "0" ]]; then
  if command -v aoc-cleanup >/dev/null 2>&1; then
    cleanup_log="$state_dir/cleanup.log"
    mkdir -p "$state_dir"
    cleanup_delay_secs="${AOC_CLEANUP_LAUNCH_DELAY_SECS:-6}"
    cleanup_min_age_secs="${AOC_CLEANUP_LAUNCH_MIN_AGE_SECS:-45}"
    (
      sleep "$cleanup_delay_secs"
      AOC_CLEANUP_INTERACTIVE=0 \
      AOC_CLEANUP_SESSIONS=current \
      AOC_CLEANUP_REQUIRE_ACTIVE_SIGNALS=1 \
      AOC_CLEANUP_SKIP_IF_NO_SESSIONS=1 \
      AOC_CLEANUP_MIN_PROCESS_AGE_SECS="$cleanup_min_age_secs" \
      aoc-cleanup >>"$cleanup_log" 2>&1
    ) &
  fi
fi

if [[ -n "${AOC_LAYOUT:-}" ]]; then
  layout="$AOC_LAYOUT"
elif [[ -f "$default_layout_file" ]]; then
  layout="$(cat "$default_layout_file")"
elif [[ -f "$local_layout" ]]; then
  layout="aoc.local"
else
  layout="aoc"
fi

sanitize_name() {
  local raw="$1"
  raw="$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]')"
  raw="$(printf '%s' "$raw" | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g')"
  printf '%s' "${raw:-tab}"
}

generate_whimsical_session_id() {
  local nouns=(
    otter badger alpaca ferret penguin walrus narwhal yak koala gecko
    capybara platypus lemur puffin iguana beaver hedgehog squirrel raccoon
    aardvark wombat lynx mojito noodle waffle pixel
  )
  local verbs=(
    juggles debugs compiles refactors lints ships rebases squashes syncs
    profiles benches deploys patches bisects tests tidies wrangles explores
    orchestrates untangles snapshots autopilots
  )
  local noun="${nouns[RANDOM % ${#nouns[@]}]}"
  local verb="${verbs[RANDOM % ${#verbs[@]}]}"
  printf '%s-%s' "$noun" "$verb"
}

session_name_exists() {
  local candidate="$1"
  if ! command -v zellij >/dev/null 2>&1; then
    return 1
  fi
  zellij list-sessions --short --no-formatting 2>/dev/null | grep -Fxq "$candidate"
}

resolve_session_id() {
  if [[ -n "${ZELLIJ_SESSION_NAME:-}" ]]; then
    printf '%s' "$ZELLIJ_SESSION_NAME"
    return
  fi
  if [[ -n "${AOC_SESSION_ID:-}" ]]; then
    printf '%s' "$AOC_SESSION_ID"
    return
  fi
  local candidate=""
  local attempt
  for attempt in 1 2 3 4 5 6 7 8 9 10 11 12; do
    candidate="$(generate_whimsical_session_id)"
    if session_name_exists "$candidate"; then
      continue
    fi
    printf '%s' "$candidate"
    return
  done
  printf 'pid-%s' "$$"
}

derive_port() {
  local session="$1"
  if ! command -v python3 >/dev/null 2>&1; then
    printf '42000'
    return
  fi
  python3 - <<'PY' "$session"
import sys
session = sys.argv[1].encode()
hash_value = 2166136261
for byte in session:
    hash_value ^= byte
    hash_value = (hash_value * 16777619) & 0xFFFFFFFF
port = 42000 + (hash_value % 2000)
print(port)
PY
}

resolve_hub_addr() {
  local session_id="$1"
  if [[ -n "${AOC_HUB_ADDR:-}" ]]; then
    printf '%s' "$AOC_HUB_ADDR"
    return
  fi
  local port
  port="$(derive_port "$session_id")"
  printf '127.0.0.1:%s' "$port"
}

resolve_hub_url() {
  local hub_addr="$1"
  if [[ -n "${AOC_HUB_URL:-}" ]]; then
    printf '%s' "$AOC_HUB_URL"
    return
  fi
  printf 'ws://%s/ws' "$hub_addr"
}

hub_health_ok() {
  local addr="$1"
  if command -v curl >/dev/null 2>&1; then
    local body
    body="$(curl -fsS --max-time 1 "http://$addr/health" 2>/dev/null || true)"
    [[ "$body" == "ok" ]]
    return
  fi
  if command -v python3 >/dev/null 2>&1; then
    python3 - <<'PY' "$addr"
import sys
import urllib.request

url = f"http://{sys.argv[1]}/health"
try:
    with urllib.request.urlopen(url, timeout=1) as resp:
        body = resp.read().decode("utf-8", errors="ignore").strip()
        if body == "ok":
            raise SystemExit(0)
except Exception:
    pass
raise SystemExit(1)
PY
    return
  fi
  return 1
}

ensure_hub_running() {
  local session_id="$1"
  local hub_addr="$2"
  local state_root="$3"
  local session_slug
  session_slug="$(sanitize_name "$session_id")"
  local pid_file="$state_root/hub-${session_slug}.pid"
  local log_file="$state_root/hub-${session_slug}.log"

  if hub_health_ok "$hub_addr"; then
    return
  fi

  if [[ -f "$pid_file" ]]; then
    local existing_pid
    existing_pid="$(cat "$pid_file" 2>/dev/null || true)"
    if [[ -n "$existing_pid" ]] && kill -0 "$existing_pid" 2>/dev/null; then
      local i
      for i in 1 2 3 4 5; do
        if hub_health_ok "$hub_addr"; then
          return
        fi
        sleep 0.2
      done
    fi
    rm -f "$pid_file"
  fi

  if ! command -v aoc-hub >/dev/null 2>&1; then
    return
  fi

  AOC_SESSION_ID="$session_id" AOC_HUB_ADDR="$hub_addr" nohup aoc-hub >>"$log_file" 2>&1 &
  local hub_pid=$!
  printf '%s\n' "$hub_pid" > "$pid_file"

  local i
  for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15; do
    if hub_health_ok "$hub_addr"; then
      return
    fi
    sleep 0.2
  done
}

cleanup_state() {
  local dir="$1"
  # Clean up old temp layout files
  find "$dir" -maxdepth 1 -type f -name 'aoc-layout-*' -mtime +30 -delete 2>/dev/null || true
  # Clean up deprecated root files (legacy)
  find "$dir" -maxdepth 1 -type f -name 'project_root.*' -delete 2>/dev/null || true
}

resolve_layout_path() {
  local layout_name="$1"
  local layout_root="${2:-}"
  if [[ "$layout_name" == /* || "$layout_name" == *.kdl ]]; then
    printf '%s' "$layout_name"
    return
  fi

  if [[ -n "$layout_root" ]]; then
    local project_layout="$layout_root/.aoc/layouts/${layout_name}.kdl"
    if [[ -f "$project_layout" ]]; then
      printf '%s' "$project_layout"
      return
    fi
  fi

  printf '%s' "$HOME/.config/zellij/layouts/${layout_name}.kdl"
}


if [[ -z "$layout" ]]; then
  layout="aoc"
fi

config_arg=()
if [[ -n "${AOC_ZELLIJ_CONFIG:-}" ]]; then
  config_arg=(--config "$AOC_ZELLIJ_CONFIG")
elif [[ -f "$aoc_config" ]]; then
  config_arg=(--config "$aoc_config")
fi

project_root="${ZELLIJ_PROJECT_ROOT:-$PWD}"
mkdir -p "$state_dir"
cleanup_state "$state_dir"

session_id="$(resolve_session_id)"
hub_addr="$(resolve_hub_addr "$session_id")"
hub_url="$(resolve_hub_url "$hub_addr")"
ensure_hub_running "$session_id" "$hub_addr" "$state_dir"

# Generate Tab Name (First word of repo, Title Case)
# e.g., agent-ops-cockpit -> Agent
raw_name="$(basename "$project_root")"
tab_name="$(echo "$raw_name" | cut -d'-' -f1 | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')"
if [[ -z "$tab_name" ]]; then tab_name="AOC"; fi

# Agent ID is just the raw repo name (used in pane name for alignment)
agent_id="$raw_name"

layout_path="$(resolve_layout_path "$layout" "$project_root")"
layout_arg="$layout"

if [[ -f "$layout_path" ]]; then
  layout_label="$(sanitize_name "$(basename "$layout")")"
  layout_tmp="$state_dir/aoc-layout-${layout_label}-${agent_id}.kdl"
  
  # Inject tab name, agent id, and project root into layout template
  awk -v tab_name="$tab_name" \
      -v agent_id="$agent_id" \
      -v proj_root="$project_root" \
      -v session_id="$session_id" \
      -v hub_addr="$hub_addr" \
      -v hub_url="$hub_url" '
  {
    gsub(/__AOC_TAB_NAME__/, tab_name)
    gsub(/__AOC_AGENT_ID__/, agent_id)
    gsub(/__AOC_PROJECT_ROOT__/, proj_root)
    gsub(/__AOC_SESSION_ID__/, session_id)
    gsub(/__AOC_HUB_ADDR__/, hub_addr)
    gsub(/__AOC_HUB_URL__/, hub_url)
    print
  }
' "$layout_path" > "$layout_tmp"
  layout_arg="$layout_tmp"

fi

# Project identification exported for layout template substitution
export AOC_ROOT_TAG="$agent_id"

# If running inside Zellij, launch a new tab in the current session
if [[ -n "${ZELLIJ:-}" ]]; then
  AOC_SESSION_ID="$session_id" \
    AOC_HUB_ADDR="$hub_addr" \
    AOC_HUB_URL="$hub_url" \
    AOC_PROJECT_ROOT="$project_root" \
    zellij action new-tab --layout "$layout_arg"
  exit 0
fi

# Otherwise, launch a new session
session_arg=(--session "$session_id")
ZELLIJ_PROJECT_ROOT="$project_root" \
  AOC_PROJECT_ROOT="$project_root" \
  AOC_SESSION_ID="$session_id" \
  AOC_HUB_ADDR="$hub_addr" \
  AOC_HUB_URL="$hub_url" \
  AOC_ROOT_TAG="$agent_id" \
  zellij "${config_arg[@]}" "${session_arg[@]}" --new-session-with-layout "$layout_arg"
