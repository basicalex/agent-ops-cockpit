#!/usr/bin/env bash
set -euo pipefail

layout="${AOC_LAYOUT:-aoc}"
local_layout="$HOME/.config/zellij/layouts/aoc.local.kdl"
aoc_config="$HOME/.config/zellij/aoc.config.kdl"
state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"

sanitize_name() {
  local raw="$1"
  raw="$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]')"
  raw="$(printf '%s' "$raw" | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g')"
  printf '%s' "${raw:-tab}"
}

cleanup_state() {
  local dir="$1"
  find "$dir" -maxdepth 1 -type f \( \
    -name 'project_root.*' -o \
    -name 'starred_root.*' -o \
    -name 'aoc-layout-*' \
  \) -mtime +30 -delete 2>/dev/null || true
}

resolve_layout_path() {
  local layout_name="$1"
  if [[ "$layout_name" == /* || "$layout_name" == *.kdl ]]; then
    printf '%s' "$layout_name"
    return
  fi
  printf '%s' "$HOME/.config/zellij/layouts/${layout_name}.kdl"
}

inject_plugin_root_file() {
  local layout_path="$1"
  local output_path="$2"
  local root_file="$3"
  local star_file="$4"
  local root_tag="$5"
  local project_root="$6"
  awk -v root_file="$root_file" -v star_file="$star_file" -v root_tag="$root_tag" -v proj_root="$project_root" '
    {
      gsub(/__AOC_PROJECT_ROOT_FILE__/, root_file)
      gsub(/__AOC_STAR_FILE__/, star_file)
      gsub(/__AOC_ROOT_TAG__/, root_tag)
      gsub(/__AOC_PROJECT_ROOT__/, proj_root)
      print
    }
    $0 ~ /plugin location=.*aoc-taskmaster\.wasm/ { in_plugin=1 }
    in_plugin && $0 ~ /refresh_secs/ {
      print "                root_file \"" root_file "\""
      in_plugin=0
    }
  ' "$layout_path" > "$output_path"
}

if [[ -z "${AOC_LAYOUT:-}" && -f "$local_layout" ]]; then
  layout="aoc.local"
fi

config_arg=()
if [[ -n "${AOC_ZELLIJ_CONFIG:-}" ]]; then
  config_arg=(--config "$AOC_ZELLIJ_CONFIG")
elif [[ -f "$aoc_config" ]]; then
  config_arg=(--config "$aoc_config")
fi

project_root="${ZELLIJ_PROJECT_ROOT:-$PWD}"
mkdir -p "$state_dir"
cleanup_state "$state_dir"

root_label="$(sanitize_name "$(basename "$project_root")")"
timestamp="$(date +%Y%m%d-%H%M%S)"
root_tag="${root_label}-${timestamp}"
project_root_file="$state_dir/project_root.${root_tag}"
star_file="$state_dir/starred_root.${root_tag}"
printf '%s\n' "$project_root" > "$project_root_file"
printf '%s\n' "$project_root" > "$star_file"

layout_path="$(resolve_layout_path "$layout")"
layout_arg="$layout"
if [[ -f "$layout_path" ]]; then
  layout_label="$(sanitize_name "$(basename "$layout")")"
    layout_tmp="$state_dir/aoc-layout-${layout_label}-${root_tag}.kdl"
    inject_plugin_root_file "$layout_path" "$layout_tmp" "$project_root_file" "$star_file" "$root_tag" "$project_root"
    layout_arg="$layout_tmp"

fi

session_name="aoc-${root_tag}"

if command -v aoc-session-watch >/dev/null 2>&1; then
  nohup aoc-session-watch "$root_tag" "$layout_arg" "$project_root_file" "$star_file" >/dev/null 2>&1 &
fi

if command -v aoc-watcher >/dev/null 2>&1; then
  nohup aoc-watcher --session "$session_name" >"$state_dir/watcher.log" 2>&1 &
fi

ZELLIJ_PROJECT_ROOT="$project_root" \
  AOC_PROJECT_ROOT="$project_root" \
  AOC_PROJECT_ROOT_FILE="$project_root_file" \
  AOC_STAR_FILE="$star_file" \
  zellij "${config_arg[@]}" --session "$session_name" --new-session-with-layout "$layout_arg"
