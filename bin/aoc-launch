#!/usr/bin/env bash
set -euo pipefail

source "$(dirname "$0")/aoc-utils.sh"

if [[ "${AOC_SMOKE_TEST:-0}" == "1" ]]; then
  exit 0
fi

layout=""
local_layout="$HOME/.config/zellij/layouts/aoc.local.kdl"
aoc_config="$HOME/.config/zellij/aoc.config.kdl"
state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"
default_layout_file="${state_dir}/layout_default"

if [[ "${AOC_CLEANUP:-1}" != "0" ]]; then
  if command -v aoc-cleanup >/dev/null 2>&1; then
    cleanup_log="$state_dir/cleanup.log"
    cleanup_lock="$state_dir/cleanup.lock"
    mkdir -p "$state_dir"
    cleanup_delay_secs="${AOC_CLEANUP_LAUNCH_DELAY_SECS:-6}"
    cleanup_min_age_secs="${AOC_CLEANUP_LAUNCH_MIN_AGE_SECS:-300}"
    (
      sleep "$cleanup_delay_secs"
      if command -v flock >/dev/null 2>&1; then
        (
          flock -n 9 || exit 0
          AOC_CLEANUP_INTERACTIVE=0 \
          AOC_CLEANUP_SESSIONS=current \
          AOC_CLEANUP_PANE_STRICT=0 \
          AOC_CLEANUP_REQUIRE_ACTIVE_SIGNALS=1 \
          AOC_CLEANUP_SKIP_IF_NO_SESSIONS=1 \
          AOC_CLEANUP_MIN_PROCESS_AGE_SECS="$cleanup_min_age_secs" \
          aoc-cleanup >>"$cleanup_log" 2>&1
        ) 9>"$cleanup_lock"
      else
        AOC_CLEANUP_INTERACTIVE=0 \
        AOC_CLEANUP_SESSIONS=current \
        AOC_CLEANUP_PANE_STRICT=0 \
        AOC_CLEANUP_REQUIRE_ACTIVE_SIGNALS=1 \
        AOC_CLEANUP_SKIP_IF_NO_SESSIONS=1 \
        AOC_CLEANUP_MIN_PROCESS_AGE_SECS="$cleanup_min_age_secs" \
        aoc-cleanup >>"$cleanup_log" 2>&1
      fi
    ) &
  fi
fi

if [[ -n "${AOC_LAYOUT:-}" ]]; then
  layout="$AOC_LAYOUT"
elif [[ -f "$default_layout_file" ]]; then
  layout="$(cat "$default_layout_file")"
elif [[ -f "$local_layout" ]]; then
  layout="aoc.local"
else
  layout="aoc"
fi

resolve_session_id() {
  if [[ -n "${ZELLIJ_SESSION_NAME:-}" ]]; then
    printf '%s' "$ZELLIJ_SESSION_NAME"
    return
  fi
  if [[ -n "${AOC_SESSION_ID:-}" ]]; then
    printf '%s' "$AOC_SESSION_ID"
    return
  fi
  local candidate=""
  local attempt
  for attempt in 1 2 3 4 5 6 7 8 9 10 11 12; do
    candidate="$(generate_whimsical_session_id)"
    if session_name_exists "$candidate"; then
      continue
    fi
    printf '%s' "$candidate"
    return
  done
  printf 'pid-%s' "$$"
}

cleanup_state() {
  local dir="$1"
  # Clean up old temp layout files
  find "$dir" -maxdepth 1 -type f -name 'aoc-layout-*' -mtime +30 -delete 2>/dev/null || true
  # Clean up deprecated root files (legacy)
  find "$dir" -maxdepth 1 -type f -name 'project_root.*' -delete 2>/dev/null || true
}

resolve_layout_path() {
  local layout_name="$1"
  local layout_root="${2:-}"
  if [[ "$layout_name" == /* || "$layout_name" == *.kdl ]]; then
    printf '%s' "$layout_name"
    return
  fi

  if [[ -n "$layout_root" ]]; then
    local project_layout="$layout_root/.aoc/layouts/${layout_name}.kdl"
    if [[ -f "$project_layout" ]]; then
      printf '%s' "$project_layout"
      return
    fi
  fi

  printf '%s' "$HOME/.config/zellij/layouts/${layout_name}.kdl"
}

sync_aoc_theme_profile() {
  local script_dir theme_env preferred_name=()
  script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  theme_env="${XDG_CONFIG_HOME:-$HOME/.config}/aoc/theme.env"

  if [[ -f "$theme_env" ]]; then
    local from_profile
    from_profile="$(awk -F '"' '/^[[:space:]]*export[[:space:]]+AOC_THEME_NAME=/{print $2; exit}' "$theme_env")"
    if [[ -n "$from_profile" ]]; then
      preferred_name=(--name "$from_profile")
    fi
  fi

  if [[ -x "$HOME/.local/bin/aoc-theme" ]]; then
    "$HOME/.local/bin/aoc-theme" sync "${preferred_name[@]}" >/dev/null 2>&1 || true
  elif command -v aoc-theme >/dev/null 2>&1; then
    aoc-theme sync "${preferred_name[@]}" >/dev/null 2>&1 || true
  elif [[ -x "$script_dir/aoc-theme" ]]; then
    "$script_dir/aoc-theme" sync "${preferred_name[@]}" >/dev/null 2>&1 || true
  fi
}

load_aoc_theme_values() {
  AOC_THEME_BLUE="#89B4FA"
  AOC_THEME_GREEN="#A6E3A1"
  AOC_THEME_RED="#F38BA8"
  AOC_THEME_ORANGE="#FAB387"
  AOC_THEME_YELLOW="#F9E2AF"
  AOC_THEME_CYAN="#94E2D5"
  AOC_THEME_MAGENTA="#CBA6F7"
  AOC_THEME_BLACK="#6C7086"
  AOC_THEME_WHITE="#9399B2"

  AOC_THEME_UI_PRIMARY="$AOC_THEME_WHITE"
  AOC_THEME_UI_MUTED="$AOC_THEME_BLACK"
  AOC_THEME_UI_ACCENT="$AOC_THEME_BLUE"
  AOC_THEME_BG_BASE="#1E1E2E"
  AOC_THEME_BG_ELEVATED="$AOC_THEME_BLACK"
  AOC_THEME_BG_SUBTLE="$AOC_THEME_BLACK"
  AOC_THEME_BG_ACCENT="$AOC_THEME_BLUE"

  local theme_env="${XDG_CONFIG_HOME:-$HOME/.config}/aoc/theme.env"
  if [[ -f "$theme_env" ]]; then
    # shellcheck disable=SC1090
    source "$theme_env"
  fi
}


if [[ -z "$layout" ]]; then
  layout="aoc"
fi

config_arg=()
if [[ -n "${AOC_ZELLIJ_CONFIG:-}" ]]; then
  config_arg=(--config "$AOC_ZELLIJ_CONFIG")
elif [[ -f "$aoc_config" ]]; then
  config_arg=(--config "$aoc_config")
fi

project_root="${ZELLIJ_PROJECT_ROOT:-$PWD}"
launch_agent="${AOC_LAUNCH_AGENT_ID:-${AOC_AGENT_ID:-}}"
mkdir -p "$state_dir"
cleanup_state "$state_dir"
sync_aoc_theme_profile
load_aoc_theme_values

session_id="$(resolve_session_id)"
hub_addr="$(resolve_hub_addr "$session_id")"
hub_url="$(resolve_hub_url "$hub_addr")"
ensure_hub_running "$session_id" "$hub_addr" "$state_dir"

# Generate Tab Name (First word of repo, Title Case)
# e.g., agent-ops-cockpit -> Agent
raw_name="$(basename "$project_root")"
tab_name="$(echo "$raw_name" | cut -d'-' -f1 | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')"
if [[ -z "$tab_name" ]]; then tab_name="AOC"; fi

# Agent ID is just the raw repo name (used in pane name for alignment)
agent_id="$raw_name"

layout_path="$(resolve_layout_path "$layout" "$project_root")"
layout_arg="$layout"

if [[ -f "$layout_path" ]]; then
  layout_label="$(sanitize_name "$(basename "$layout")")"
  layout_tmp="$state_dir/aoc-layout-${layout_label}-${agent_id}.kdl"
  
  # Inject tab name, agent id, and project root into layout template
  awk -v tab_name="$tab_name" \
      -v agent_id="$agent_id" \
      -v launch_agent="$launch_agent" \
      -v proj_root="$project_root" \
      -v session_id="$session_id" \
      -v hub_addr="$hub_addr" \
      -v hub_url="$hub_url" \
      -v theme_blue="$AOC_THEME_BLUE" \
      -v theme_green="$AOC_THEME_GREEN" \
      -v theme_red="$AOC_THEME_RED" \
      -v theme_orange="$AOC_THEME_ORANGE" \
      -v theme_yellow="$AOC_THEME_YELLOW" \
      -v theme_cyan="$AOC_THEME_CYAN" \
      -v theme_magenta="$AOC_THEME_MAGENTA" \
      -v theme_black="$AOC_THEME_BLACK" \
      -v theme_white="$AOC_THEME_WHITE" \
      -v theme_ui_primary="$AOC_THEME_UI_PRIMARY" \
      -v theme_ui_muted="$AOC_THEME_UI_MUTED" \
      -v theme_ui_accent="$AOC_THEME_UI_ACCENT" \
      -v theme_bg_base="$AOC_THEME_BG_BASE" \
      -v theme_bg_elevated="$AOC_THEME_BG_ELEVATED" \
      -v theme_bg_subtle="$AOC_THEME_BG_SUBTLE" \
      -v theme_bg_accent="$AOC_THEME_BG_ACCENT" '
  {
    gsub(/__AOC_TAB_NAME__/, tab_name)
    gsub(/__AOC_AGENT_ID__/, agent_id)
    gsub(/__AOC_PROJECT_ROOT__/, proj_root)
    gsub(/__AOC_SESSION_ID__/, session_id)
    gsub(/__AOC_HUB_ADDR__/, hub_addr)
    gsub(/__AOC_HUB_URL__/, hub_url)
    gsub(/__AOC_THEME_BLUE__/, theme_blue)
    gsub(/__AOC_THEME_GREEN__/, theme_green)
    gsub(/__AOC_THEME_RED__/, theme_red)
    gsub(/__AOC_THEME_ORANGE__/, theme_orange)
    gsub(/__AOC_THEME_YELLOW__/, theme_yellow)
    gsub(/__AOC_THEME_CYAN__/, theme_cyan)
    gsub(/__AOC_THEME_MAGENTA__/, theme_magenta)
    gsub(/__AOC_THEME_BLACK__/, theme_black)
    gsub(/__AOC_THEME_WHITE__/, theme_white)
    gsub(/__AOC_THEME_UI_PRIMARY__/, theme_ui_primary)
    gsub(/__AOC_THEME_UI_MUTED__/, theme_ui_muted)
    gsub(/__AOC_THEME_UI_ACCENT__/, theme_ui_accent)
    gsub(/__AOC_THEME_BG_BASE__/, theme_bg_base)
    gsub(/__AOC_THEME_BG_ELEVATED__/, theme_bg_elevated)
    gsub(/__AOC_THEME_BG_SUBTLE__/, theme_bg_subtle)
    gsub(/__AOC_THEME_BG_ACCENT__/, theme_bg_accent)
    if (launch_agent != "") {
      gsub(/AOC_AGENT_RUN=1 exec /, "AOC_AGENT_ID=" launch_agent " AOC_AGENT_RUN=1 exec ")
    }
    print
  }
' "$layout_path" > "$layout_tmp"
  layout_arg="$layout_tmp"

fi

# Project identification exported for layout template substitution
export AOC_ROOT_TAG="$agent_id"

# If running inside Zellij, launch a new tab in the current session
if [[ -n "${ZELLIJ:-}" ]]; then
  AOC_SESSION_ID="$session_id" \
    AOC_HUB_ADDR="$hub_addr" \
    AOC_HUB_URL="$hub_url" \
    AOC_PROJECT_ROOT="$project_root" \
    zellij action new-tab --layout "$layout_arg"
  exit 0
fi

# Otherwise, launch a new session
session_arg=(--session "$session_id")
ZELLIJ_PROJECT_ROOT="$project_root" \
  AOC_PROJECT_ROOT="$project_root" \
  AOC_SESSION_ID="$session_id" \
  AOC_HUB_ADDR="$hub_addr" \
  AOC_HUB_URL="$hub_url" \
  AOC_ROOT_TAG="$agent_id" \
  zellij "${config_arg[@]}" "${session_arg[@]}" --new-session-with-layout "$layout_arg"
