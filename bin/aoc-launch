#!/usr/bin/env bash
set -euo pipefail

layout="${AOC_LAYOUT:-aoc}"
local_layout="$HOME/.config/zellij/layouts/aoc.local.kdl"
aoc_config="$HOME/.config/zellij/aoc.config.kdl"
state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/aoc"

sanitize_name() {
  local raw="$1"
  raw="$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]')"
  raw="$(printf '%s' "$raw" | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g')"
  printf '%s' "${raw:-tab}"
}

cleanup_state() {
  local dir="$1"
  # Clean up old temp layout files
  find "$dir" -maxdepth 1 -type f -name 'aoc-layout-*' -mtime +30 -delete 2>/dev/null || true
  # Clean up deprecated root files (legacy)
  find "$dir" -maxdepth 1 -type f -name 'project_root.*' -delete 2>/dev/null || true
  find "$dir" -maxdepth 1 -type f -name 'starred_root.*' -delete 2>/dev/null || true
}

resolve_layout_path() {
  local layout_name="$1"
  if [[ "$layout_name" == /* || "$layout_name" == *.kdl ]]; then
    printf '%s' "$layout_name"
    return
  fi
  printf '%s' "$HOME/.config/zellij/layouts/${layout_name}.kdl"
}


if [[ -z "${AOC_LAYOUT:-}" && -f "$local_layout" ]]; then
  layout="aoc.local"
fi

config_arg=()
if [[ -n "${AOC_ZELLIJ_CONFIG:-}" ]]; then
  config_arg=(--config "$AOC_ZELLIJ_CONFIG")
elif [[ -f "$aoc_config" ]]; then
  config_arg=(--config "$aoc_config")
fi

project_root="${ZELLIJ_PROJECT_ROOT:-$PWD}"
mkdir -p "$state_dir"
cleanup_state "$state_dir"

# Generate Tab Name (First word of repo, Title Case)
# e.g., agent-ops-cockpit -> Agent
raw_name="$(basename "$project_root")"
tab_name="$(echo "$raw_name" | cut -d'-' -f1 | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')"
if [[ -z "$tab_name" ]]; then tab_name="AOC"; fi

# Agent ID is just the raw repo name (used in pane name for alignment)
agent_id="$raw_name"

layout_path="$(resolve_layout_path "$layout")"
layout_arg="$layout"

if [[ -f "$layout_path" ]]; then
  layout_label="$(sanitize_name "$(basename "$layout")")"
  layout_tmp="$state_dir/aoc-layout-${layout_label}-${agent_id}.kdl"
  
  # Inject tab name, agent id, and project root into layout template
  awk -v tab_name="$tab_name" \
      -v agent_id="$agent_id" \
      -v proj_root="$project_root" '
  {
    gsub(/__AOC_TAB_NAME__/, tab_name)
    gsub(/__AOC_AGENT_ID__/, agent_id)
    gsub(/__AOC_PROJECT_ROOT__/, proj_root)
    print
  }
' "$layout_path" > "$layout_tmp"
  layout_arg="$layout_tmp"

fi

# Project identification exported for layout template substitution
export AOC_ROOT_TAG="$agent_id"

# If running inside Zellij, launch a new tab in the current session
if [[ -n "${ZELLIJ:-}" ]]; then
  zellij action new-tab --layout "$layout_arg"
  exit 0
fi

# Otherwise, launch a new session
ZELLIJ_PROJECT_ROOT="$project_root" \
  AOC_PROJECT_ROOT="$project_root" \
  AOC_ROOT_TAG="$agent_id" \
  zellij "${config_arg[@]}" --new-session-with-layout "$layout_arg"
