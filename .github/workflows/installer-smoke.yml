name: Installer Smoke

on:
  pull_request:
  push:
    branches: [main]
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  fallback-smoke:
    name: Fallback smoke (${{ matrix.ubuntu_image }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ubuntu_image: ["22.04", "24.04"]

    steps:
      - name: Run fallback installer path as non-root user
        run: |
          docker run --rm -e GITHUB_TOKEN="${{ github.token }}" "ubuntu:${{ matrix.ubuntu_image }}" bash -lc '
            set -euo pipefail
            apt-get update
            apt-get install -y ca-certificates curl git sudo
            useradd -m -s /bin/bash tester
            echo "tester ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/tester
            sudo --preserve-env=GITHUB_TOKEN -u tester bash -lc "
              set -euo pipefail
              curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/install/bootstrap.sh \
                | bash -s -- --repo ${{ github.repository }} --ref ${{ github.sha }} --yes --skip-doctor

              export PATH=\"\$HOME/.local/bin:\$PATH\"
              command -v aoc
              command -v aoc-init
              command -v aoc-doctor
              test -f ~/.config/zellij/layouts/aoc.kdl
              test -f ~/.config/yazi/yazi.toml

              mkdir -p ~/sandbox && cd ~/sandbox
              git init
              aoc-init
              test -f .aoc/context.md
              test -f .aoc/memory.md
              test -f .taskmaster/tasks/tasks.json

              curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/install/bootstrap.sh \
                | bash -s -- --repo ${{ github.repository }} --ref ${{ github.sha }} --yes --skip-doctor
            "
          '

  release-smoke:
    name: Release smoke (${{ matrix.ubuntu_image }})
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ubuntu_image: ["22.04", "24.04"]

    steps:
      - name: Run release installer asset path as non-root user
        run: |
          docker run --rm -e GITHUB_TOKEN="${{ github.token }}" "ubuntu:${{ matrix.ubuntu_image }}" bash -lc '
            set -euo pipefail
            apt-get update
            apt-get install -y ca-certificates curl git sudo
            useradd -m -s /bin/bash tester
            echo "tester ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/tester
            sudo --preserve-env=GITHUB_TOKEN -u tester bash -lc "
              set -euo pipefail
              curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/install/bootstrap.sh \
                | bash -s -- --repo ${{ github.repository }} --ref ${{ github.ref_name }} --yes --skip-doctor

              export PATH=\"\$HOME/.local/bin:\$PATH\"
              command -v aoc
              command -v aoc-init
              command -v aoc-doctor
              test -f ~/.config/zellij/layouts/aoc.kdl
              test -f ~/.config/yazi/yazi.toml

              mkdir -p ~/sandbox && cd ~/sandbox
              git init
              aoc-init
              test -f .aoc/context.md
              test -f .aoc/memory.md
              test -f .taskmaster/tasks/tasks.json

              curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/install/bootstrap.sh \
                | bash -s -- --repo ${{ github.repository }} --ref ${{ github.ref_name }} --yes --skip-doctor
            "
          '
